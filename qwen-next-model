@Test
void createTransfers_Success() {
    // Arrange
    CreateTransferRequest request = new CreateTransferRequest();
    CreateTransferRequestData data = new CreateTransferRequestData();
    request.setData(data);
    request.getData().setSenderInvestmentAccountChecksumIdentifier("CHECKSUM123");
    request.getData().setActionRequestCode(ActionRequestCode.D);
    List<ReceiverInfo> receivers = new ArrayList<>();
    ReceiverInfo receiver = new ReceiverInfo();
    receiver.setTransferQuantity(new BigDecimal("10.5"));
    receiver.setReceiverCustomerNumber("RECEIVER123");
    receivers.add(receiver);
    request.getData().setReceiverLists(receivers);

    // ✅ 1. Mock retrieveAccountIdWithCheckSum (via restClientService.get to customerAccountUrl)
    RetrieveCustomerAccountsIdListResponse accountIdListResponse = new RetrieveCustomerAccountsIdListResponse();
    InvestmentAccountId accountId = new InvestmentAccountId();
    accountId.setCountryAccountCode("HK");
    accountId.setGroupMemberAccountCode("HBAP");
    accountId.setAccountNumber("123456789");
    accountId.setAccountProductTypeCode("SAV");
    accountId.setAccountTypeCode("01");
    accountId.setAccountCurrencyCode("HKD");
    InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
    accountIdList.setAccountId(accountId);
    accountIdListResponse.setAccountIdList(Collections.singletonList(accountIdList));
    when(restClientService.get(
            anyString(),
            anyMap(),
            eq(RetrieveCustomerAccountsIdListResponse.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(accountIdListResponse);

    // ✅ 2. Mock retrieveCustomerNamesWithCinNumber (required by setSenderNames)
    PartyNameResponse partyNameResponse = new PartyNameResponse();
    PartyName name = new PartyName();
    name.setGivenName("John");
    name.setCustomerChristianName("Michael");
    name.setLastName("Doe");
    partyNameResponse.setName(name);
    when(restClientService.get(
            anyString(),
            anyMap(),
            eq(PartyNameResponse.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(partyNameResponse);

    // ✅ 3. Mock SRE validation for receivers (关键！)
    RuleResponse sreResponse = new RuleResponse();
    // 注意：validateSreForReceivers 会为每个 receiver 调用一次 callSreForTransferValidation
    // sender = sourceRequestHeader.get(X_HSBC_CUSTOMER_ID) = "CUST123"
    // receiver = "RECEIVER123"
    // rule = "dac_tokenized_gold_transfer_sender_rule"
    when(sreValidationService.callSreForTransferValidation(
            eq("dac_tokenized_gold_transfer_sender_rule"),
            eq("CUST123"),
            eq("RECEIVER123"),
            anyMap() // headersWithE2ETrustToken
    )).thenReturn(sreResponse);

    // ✅ 4. Mock GoldPrice (for ActionRequestCode.D)
    GoldPriceResponse goldPriceResponse = createMockGoldPriceResponse();
    when(restClientService.get(
            anyString(),
            anyMap(),
            eq(GoldPriceResponse.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(goldPriceResponse);

    // ✅ 5. Mock tradeLimitService
    RetrieveTransferLimitResponse limitResponse = createMockTransferLimitResponse();
    when(tradeLimitService.retrieveLimitations(anyMap())).thenReturn(limitResponse);

    // ✅ 6. ✅ CRITICAL FIX: Mock final post to trade-online with a NON-NULL data object!
    // 创建一个 CreateTransferResponseData 对象
    CreateTransferResponseData responseData = new CreateTransferResponseData();
    // 为 data 设置一个非空的 responseDetails，这是 ResponseInfoHandler.prepareResponse 最可能需要的
    ResponseDetails responseDetails = new ResponseDetails();
    responseDetails.setResponseCodeNumber(0); // 成功状态码
    responseData.setResponseDetails(responseDetails); // ✅ 关键：设置 data 的 responseDetails
    // 创建最终的 CreateTransferResponse 对象
    CreateTransferResponse mockResponse = new CreateTransferResponse();
    mockResponse.setData(responseData); // ✅ 关键：将 data 设置到 response 上！
    // ✅ 可选：如果 ResponseInfoHandler 也检查顶层的 responseDetails，可以一并设置
    mockResponse.setResponseDetails(responseDetails);

    when(restClientService.post(
            anyString(),
            anyMap(),
            any(CreateTransferRequest.class),
            eq(CreateTransferResponse.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(mockResponse); // ✅ 返回一个 data 和 responseDetails 都非空的对象

    // Act
    CreateTransferResponse result = tradeTransferService.createTransfers(sourceRequestHeader, request);

    // Assert
    assertNotNull(result);
    assertNotNull(result.getData());
    assertNotNull(result.getData().getResponseDetails());
    assertEquals(0, result.getData().getResponseDetails().getResponseCodeNumber());

    // ✅ Verify all critical calls
    verify(tradeLimitService, times(1)).retrieveLimitations(anyMap());
    verify(restClientService, times(1)).get(
            anyString(),
            anyMap(),
            eq(RetrieveCustomerAccountsIdListResponse.class),
            anyInt(),
            anyBoolean()
    );
    verify(restClientService, times(1)).get(
            anyString(),
            anyMap(),
            eq(PartyNameResponse.class),
            anyInt(),
            anyBoolean()
    );
    verify(restClientService, times(1)).get(
            anyString(),
            anyMap(),
            eq(GoldPriceResponse.class),
            anyInt(),
            anyBoolean()
    );
    verify(sreValidationService, times(1)).callSreForTransferValidation(
            eq("dac_tokenized_gold_transfer_sender_rule"),
            eq("CUST123"),
            eq("RECEIVER123"),
            anyMap()
    );
    verify(restClientService, times(1)).post(
            anyString(),
            anyMap(),
            any(CreateTransferRequest.class),
            eq(CreateTransferResponse.class),
            anyInt(),
            anyBoolean()
    );
}
