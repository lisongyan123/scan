package com.hsbc.trade.transfer.service.impl;

import com.hsbc.trade.HTTPRequestHeaderConstants;
import com.hsbc.trade.common.AccountId;
import com.hsbc.trade.service.RestClientService;
import com.hsbc.trade.transfer.domain.account.CustomerAccounts;
import com.hsbc.trade.transfer.domain.account.InvestmentAccount;
import com.hsbc.trade.transfer.domain.cep.PartyContactResponse;
import com.hsbc.trade.transfer.domain.cep.PartyNameResponse;
import com.hsbc.trade.transfer.domain.mds.GoldPriceResponse;
import com.hsbc.trade.transfer.domain.mds.GoldPriceResponseData;
import com.hsbc.trade.transfer.service.AbstractRestService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpHeaders;

import java.math.BigDecimal;
import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

/**
 * 单元测试类：TradeTransferServiceImpl
 * 通过 Mock RestClientService 来测试所有远程调用逻辑。
 */
@ExtendWith(MockitoExtension.class)
class TradeTransferServiceImplTest {

    @Mock
    private RestClientService restClientService;

    @Mock
    private com.hsbc.trade.utils.E2ETrustTokenUtil e2ETrustTokenUtil;

    @Mock
    private com.hsbc.trade.service.DuplicateSubmitPreventionService duplicateSubmitPreventionService;

    @Mock
    private com.hsbc.trade.transfer.service.TradeLimitServiceImpl tradeLimitService;

    @Mock
    private com.hsbc.trade.transfer.service.SreValidationServiceImpl sreValidationService;

    @InjectMocks
    private TradeTransferServiceImpl tradeTransferService; // 被测试的类

    // 测试数据
    private Map<String, String> mockRequestHeaders;
    private String mockCinNumber = "CIN123456";
    private String mockChecksum = "CHECKSUM_789";

    @BeforeEach
    void setUp() {
        // 初始化通用的请求头
        mockRequestHeaders = new HashMap<>();
        mockRequestHeaders.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID, mockCinNumber);
        mockRequestHeaders.put(HTTPRequestHeaderConstants.X_HSBC_E2E_TRUST_TOKEN, "mock_e2e_token");

        // 模拟 E2E Trust Token
        when(e2ETrustTokenUtil.getE2ETrustToken()).thenReturn("mock_e2e_token");
    }

    /**
     * 测试：retrieveCustomerAccounts 方法
     * 验证：调用 restClientService.get，传入正确的 URL 和 headers，返回预期的 CustomerAccounts 对象。
     */
    @Test
    void testRetrieveCustomerAccounts_Success() {
        // Arrange
        CustomerAccounts mockCustomerAccounts = new CustomerAccounts();
        List<InvestmentAccount> mockInvestmentAccounts = new ArrayList<>();
        InvestmentAccount mockAccount = new InvestmentAccount();
        mockAccount.setChecksum("checksum1");
        mockInvestmentAccounts.add(mockAccount);
        mockCustomerAccounts.setInvestmentAccountList(mockInvestmentAccounts);

        // 模拟 restClientService 的返回值
        when(restClientService.get(anyString(), eq(mockRequestHeaders), eq(CustomerAccounts.class), anyInt(), anyBoolean()))
                .thenReturn(mockCustomerAccounts);

        // Act
        CustomerAccounts result = tradeTransferService.retrieveCustomerAccounts(mockRequestHeaders);

        // Assert
        assertNotNull(result);
        assertEquals(mockInvestmentAccounts, result.getInvestmentAccountList());
        verify(restClientService).get(
                contains("accounts-map"), // 验证 URL 包含 accounts-map
                eq(mockRequestHeaders),
                eq(CustomerAccounts.class),
                eq(AbstractRestService.class.getDeclaredField("timeout").getLong(tradeTransferService)), // 验证 timeout
                eq(true) // 验证 printMessageLog
        );
    }

    /**
     * 测试：retrieveAccountIdWithCheckSum 方法
     * 验证：调用 retrieveCustomerAccountIdsList，解析返回的 AccountId 并返回。
     */
    @Test
    void testRetrieveAccountIdWithCheckSum_Success() {
        // Arrange
        RetrieveCustomerAccountsIdListResponse mockResponse = new RetrieveCustomerAccountsIdListResponse();
        List<com.hsbc.trade.transfer.domain.account.AccountId> mockAccountIdList = new ArrayList<>();
        com.hsbc.trade.transfer.domain.account.AccountId mockAccountId = new com.hsbc.trade.transfer.domain.account.AccountId();
        mockAccountId.setCountryAccountCode("HK");
        mockAccountId.setGroupMemberAccountCode("GM1");
        mockAccountId.setAccountNumber("ACC123");
        mockAccountId.setAccountProductTypeCode("PROD");
        mockAccountId.setAccountTypeCode("TYPE");
        mockAccountId.setAccountCurrencyCode("HKD");
        mockAccountIdList.add(mockAccountId);
        mockResponse.setAccountIdList(mockAccountIdList);

        // 模拟 retrieveCustomerAccountIdsList 的返回值
        when(((AbstractRestService) tradeTransferService).retrieveCustomerAccountIdsList(anyMap()))
                .thenReturn(mockResponse);

        // Act
        AccountId result = tradeTransferService.retrieveAccountIdWithCheckSum(mockRequestHeaders);

        // Assert
        assertNotNull(result);
        assertEquals("HK", result.getCountryAccountCode());
        assertEquals("GM1", result.getGroupMemberAccountCode());
        assertEquals("ACC123", result.getAccountNumber());
        assertEquals("PROD", result.getAccountProductTypeCode());
        assertEquals("TYPE", result.getAccountTypeCode());
        assertEquals("HKD", result.getAccountCurrencyCode());
        verify(((AbstractRestService) tradeTransferService)).retrieveCustomerAccountIdsList(eq(mockRequestHeaders));
    }

    /**
     * 测试：retrieveCustomerNamesWithCinNumber 方法
     * 验证：调用 updateHeaderforCEP 构建头，然后调用 restClientService.get，返回 PartyNameResponse。
     */
    @Test
    void testRetrieveCustomerNamesWithCinNumber_Success() {
        // Arrange
        PartyNameResponse mockPartyNameResponse = new PartyNameResponse();
        mockPartyNameResponse.setName(new com.hsbc.trade.transfer.domain.cep.PartyName());

        // 模拟 updateHeaderforCEP 的行为
        Map<String, String> cepHeaders = new HashMap<>(mockRequestHeaders);
        cepHeaders.put(HTTPRequestHeaderConstants.X_HSBC_E2E_TRUST_TOKEN, "mock_e2e_token");
        cepHeaders.put(HTTPRequestHeaderConstants.X_HSBC_GBGF, "mock_gbgf");
        cepHeaders.put(HTTPRequestHeaderConstants.X_HSBC_SOURCE_SYSTEM_ID, "mock_source");

        when(((AbstractRestService) tradeTransferService).updateHeaderforCEP(eq(mockRequestHeaders)))
                .thenReturn(cepHeaders);

        // 模拟 restClientService 的返回值
        when(restClientService.get(eq("cep.party.name.url"), eq(cepHeaders), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
                .thenReturn(mockPartyNameResponse);

        // Act
        PartyNameResponse result = tradeTransferService.retrieveCustomerNamesWithCinNumber(mockCinNumber, mockRequestHeaders);

        // Assert
        assertNotNull(result);
        assertEquals(mockPartyNameResponse, result);
        verify(((AbstractRestService) tradeTransferService)).updateHeaderforCEP(eq(mockRequestHeaders));
        verify(restClientService).get(eq("cep.party.name.url"), eq(cepHeaders), eq(PartyNameResponse.class), anyInt(), anyBoolean());
    }

    /**
     * 测试：retrieveCustomerPhoneNumberWithCinNumber 方法
     * 验证：调用 updateHeaderforCEP 构建头，然后调用 restClientService.get，返回 PartyContactResponse。
     */
    @Test
    void testRetrieveCustomerPhoneNumberWithCinNumber_Success() {
        // Arrange
        PartyContactResponse mockPartyContactResponse = new PartyContactResponse();
        mockPartyContactResponse.setContact(new com.hsbc.trade.transfer.domain.cep.PartyContact());

        // 模拟 updateHeaderforCEP 的行为
        Map<String, String> cepHeaders = new HashMap<>(mockRequestHeaders);
        cepHeaders.put(HTTPRequestHeaderConstants.X_HSBC_E2E_TRUST_TOKEN, "mock_e2e_token");
        cepHeaders.put(HTTPRequestHeaderConstants.X_HSBC_GBGF, "mock_gbgf");
        cepHeaders.put(HTTPRequestHeaderConstants.X_HSBC_SOURCE_SYSTEM_ID, "mock_source");

        when(((AbstractRestService) tradeTransferService).updateHeaderforCEP(eq(mockRequestHeaders)))
                .thenReturn(cepHeaders);

        // 模拟 restClientService 的返回值
        when(restClientService.get(eq("cep.party.contact.url"), eq(cepHeaders), eq(PartyContactResponse.class), anyInt(), anyBoolean()))
                .thenReturn(mockPartyContactResponse);

        // Act
        PartyContactResponse result = tradeTransferService.retrieveCustomerPhoneNumberWithCinNumber(mockCinNumber, mockRequestHeaders);

        // Assert
        assertNotNull(result);
        assertEquals(mockPartyContactResponse, result);
        verify(((AbstractRestService) tradeTransferService)).updateHeaderforCEP(eq(mockRequestHeaders));
        verify(restClientService).get(eq("cep.party.contact.url"), eq(cepHeaders), eq(PartyContactResponse.class), anyInt(), anyBoolean());
    }

    /**
     * 测试：retrieveGoldPrice 方法
     * 验证：构建正确的 URI 并调用 restClientService.get，返回 GoldPriceResponse。
     */
    @Test
    void testRetrieveGoldPrice_Success() {
        // Arrange
        GoldPriceResponse mockGoldPriceResponse = new GoldPriceResponse();
        GoldPriceResponseData mockData = new GoldPriceResponseData();
        mockData.setGoldPriceAmount(new BigDecimal("100.00"));
        mockData.setPublishTime("2023-01-01T12:00:00Z");
        mockGoldPriceResponse.setData(mockData);

        // 模拟 restClientService 的返回值
        when(restClientService.get(eq("mds.gold.quotes-endpoint/XGTHKD"), eq(mockRequestHeaders), eq(GoldPriceResponse.class), anyInt(), anyBoolean()))
                .thenReturn(mockGoldPriceResponse);

        // Act
        GoldPriceResponse result = tradeTransferService.retrieveGoldPrice(mockRequestHeaders);

        // Assert
        assertNotNull(result);
        assertNotNull(result.getData());
        assertEquals(new BigDecimal("100.00"), result.getData().getGoldPriceAmount());
        verify(restClientService).get(eq("mds.gold.quotes-endpoint/XGTHKD"), eq(mockRequestHeaders), eq(GoldPriceResponse.class), anyInt(), anyBoolean());
    }

    /**
     * 测试：createTransfers 方法中的核心远程调用流程
     * 验证：该方法会正确调用 retrieveAccountIdWithCheckSum, retrieveCustomerNamesWithCinNumber, retrieveGoldPrice, 和 tradeLimitService。
     */
    @Test
    void testCreateTransfers_Success() {
        // Arrange
        // 1. 模拟 tradeLimitService
        com.hsbc.trade.transfer.retrievetransferlimit.RetrieveTransferLimitResponse mockLimitResponse = new com.hsbc.trade.transfer.retrievetransferlimit.RetrieveTransferLimitResponse();
        com.hsbc.trade.transfer.retrievetransferlimit.RetrieveTransferLimitResponseData mockLimitData = new com.hsbc.trade.transfer.retrievetransferlimit.RetrieveTransferLimitResponseData();
        mockLimitData.setMaxDailyLimitedAmount(new BigDecimal("10000"));
        mockLimitData.setAvailableTodayAmount(new BigDecimal("5000"));
        mockLimitResponse.setData(mockLimitData);
        when(tradeLimitService.retrieveLimitations(anyMap())).thenReturn(mockLimitResponse);

        // 2. 模拟 retrieveAccountIdWithCheckSum
        AccountId mockAccountId = new AccountId();
        mockAccountId.setAccountNumber("ACC123");
        when(tradeTransferService.retrieveAccountIdWithCheckSum(anyMap())).thenReturn(mockAccountId);

        // 3. 模拟 retrieveCustomerNamesWithCinNumber
        PartyNameResponse mockPartyNameResponse = new PartyNameResponse();
        com.hsbc.trade.transfer.domain.cep.PartyName mockName = new com.hsbc.trade.transfer.domain.cep.PartyName();
        mockName.setGivenName("John");
        mockName.setLastName("Doe");
        mockName.setCustomerChristianName("Michael");
        mockPartyNameResponse.setName(mockName);
        when(tradeTransferService.retrieveCustomerNamesWithCinNumber(eq(mockCinNumber), anyMap())).thenReturn(mockPartyNameResponse);

        // 4. 模拟 retrieveGoldPrice
        GoldPriceResponse mockGoldPriceResponse = new GoldPriceResponse();
        GoldPriceResponseData mockGoldData = new GoldPriceResponseData();
        mockGoldData.setGoldPriceAmount(new BigDecimal("100.00"));
        mockGoldData.setPublishTime("2023-01-01T12:00:00Z");
        mockGoldPriceResponse.setData(mockGoldData);
        when(tradeTransferService.retrieveGoldPrice(anyMap())).thenReturn(mockGoldPriceResponse);

        // 5. 模拟 validateSreForReceivers (它内部会调用 sreValidationService，我们只关心它被调用)
        doNothing().when(tradeTransferService).validateSreForReceivers(anyList(), anyString(), anyMap());

        // 6. 模拟 restClientService.post 的返回值
        com.hsbc.trade.transfer.createtransfer.CreateTransferResponse mockResponse = new com.hsbc.trade.transfer.createtransfer.CreateTransferResponse();
        when(restClientService.post(anyString(), anyMap(), any(), eq(com.hsbc.trade.transfer.createtransfer.CreateTransferResponse.class), anyInt(), anyBoolean()))
                .thenReturn(mockResponse);

        // 7. 创建请求
        com.hsbc.trade.transfer.createtransfer.CreateTransferRequest request = new com.hsbc.trade.transfer.createtransfer.CreateTransferRequest();
        com.hsbc.trade.transfer.createtransfer.CreateTransferRequestData data = new com.hsbc.trade.transfer.createtransfer.CreateTransferRequestData();
        data.setActionRequestCode("D"); // D 操作需要金價
        data.setSenderInvestmentAccountChecksumIdentifier(mockChecksum);

        com.hsbc.trade.transfer.createtransfer.ReceiverInfo receiver = new com.hsbc.trade.transfer.createtransfer.ReceiverInfo();
        receiver.setTransferQuantity(new BigDecimal("10"));
        data.setReceiverLists(Collections.singletonList(receiver));

        data.setRequestPriceValue(new BigDecimal("100")); // 用于计算总金额
        request.setData(data);

        // Act
        com.hsbc.trade.transfer.createtransfer.CreateTransferResponse result = tradeTransferService.createTransfers(mockRequestHeaders, request);

        // Assert
        assertNotNull(result);
        // 验证所有远程调用都被执行了
        verify(tradeTransferService).retrieveAccountIdWithCheckSum(anyMap());
        verify(tradeTransferService).retrieveCustomerNamesWithCinNumber(eq(mockCinNumber), anyMap());
        verify(tradeTransferService).retrieveGoldPrice(anyMap());
        verify(tradeLimitService).retrieveLimitations(anyMap());
        verify(restClientService).post(anyString(), anyMap(), any(), eq(com.hsbc.trade.transfer.createtransfer.CreateTransferResponse.class), anyInt(), anyBoolean());
    }
}
