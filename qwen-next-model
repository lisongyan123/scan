package com.hsbc.trade.transfer.service;

import com.hsbc.trade.HTTPRequestHeaderConstants;
import com.hsbc.trade.common.AccountId;
import com.hsbc.trade.common.ResponseDetails;
import com.hsbc.trade.service.RestClientService;
import com.hsbc.trade.transfer.domain.account.CustomerAccounts;
import com.hsbc.trade.transfer.domain.account.InvestmentAccount;
import com.hsbc.trade.transfer.domain.cep.PartyContact;
import com.hsbc.trade.transfer.domain.cep.PartyContactResponse;
import com.hsbc.trade.transfer.domain.cep.PartyName;
import com.hsbc.trade.transfer.domain.cep.PartyNameResponse;
import com.hsbc.trade.transfer.domain.RetrieveCustomerAccountsIdListResponse;
import com.hsbc.trade.transfer.retrievetransferdetail.RetrieveTransferDetailResponse;
import com.hsbc.trade.transfer.retrievetransferdetail.RetrieveTransferDetailResponseData;
import com.hsbc.trade.utils.E2ETrustTokenUtil;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.test.util.ReflectionTestUtils;

import java.net.URI;
import java.nio.charset.StandardCharsets;
import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class TradeTransferServiceImplRetrieveTransferDetailTest {

    @Mock
    private RestClientService restClientService;

    @Mock
    private E2ETrustTokenUtil e2ETrustTokenUtil;

    @InjectMocks
    private TradeTransferServiceImpl tradeTransferService; // 这是被测对象

    // 配置测试常量
    private static final String MOCK_TRADE_ONLINE_URL = "http://mock-trade-online";
    private static final String MOCK_ACCOUNTS_MAP_URL = "http://mock-accounts-map";
    private static final String MOCK_CEP_PARTY_NAME_URL = "http://mock-cep-party-name";
    private static final String MOCK_CEP_PARTY_CONTACT_URL = "http://mock-cep-party-contact";

    private Map<String, String> baseRequestHeaders;

    @BeforeEach
    void setUp() {
        // 设置被测服务的私有字段（这些字段通常由 @Value 注入）
        ReflectionTestUtils.setField(tradeTransferService, "tradeOnlineUrl", MOCK_TRADE_ONLINE_URL);
        ReflectionTestUtils.setField(tradeTransferService, "accountsMapUrl", MOCK_ACCOUNTS_MAP_URL);
        ReflectionTestUtils.setField(tradeTransferService, "cepPartyNameUrl", MOCK_CEP_PARTY_NAME_URL);
        ReflectionTestUtils.setField(tradeTransferService, "cepPartyContactUrl", MOCK_CEP_PARTY_CONTACT_URL);
        ReflectionTestUtils.setField(tradeTransferService, "timeout", 10000);
        ReflectionTestUtils.setField(tradeTransferService, "printMessageLog", true);

        // 初始化请求头
        baseRequestHeaders = new HashMap<>();
        baseRequestHeaders.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID, "testCIN123");
        baseRequestHeaders.put(HTTPRequestHeaderConstants.X_HSBC_USER_ID, "testUser");
        baseRequestHeaders.put(HTTPRequestHeaderConstants.X_HSBC_SAML, "dummySamlToken");
        baseRequestHeaders.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, "dummySaml3Token");

        // Mock E2E Token
        when(e2ETrustTokenUtil.getE2ETrustToken()).thenReturn("mock-e2e-token");
    }

    @Test
    void retrieveTransferDetail_Success_WithCustomerName() {
        // Arrange
        String transferReferenceNumber = "ref123";
        String customerInternalNumber = "testCIN123"; // 从 baseRequestHeaders 提取

        // 1. Mock: retrieveTransferDetail 的远程调用返回一个完全初始化的响应对象
        // --- 关键：构建一个非空的 RetrieveTransferDetailResponse ---
        RetrieveTransferDetailResponse mockResponse = new RetrieveTransferDetailResponse();
        RetrieveTransferDetailResponseData responseData = new RetrieveTransferDetailResponseData();

        // 设置 investmentAccount (这是 ResponseInfoHandler.prepareResponse 会用到的)
        AccountId accountId = new AccountId();
        accountId.setAccountNumber("987654321"); // 必须与下面 mock 的 InvestmentAccount 一致
        responseData.setInvestmentAccount(accountId);

        // --- 关键修复：设置 responseDetails！这是 ResponseInfoHandler.prepareResponse 所必需的 ---
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0); // 成功状态码
        responseData.setResponseDetails(responseDetails); // ✅ 将 responseDetails 设置到 data 中 —— 这是解决 "baseResponse is null" 的核心！

        // 将 data 设置到顶层响应对象
        mockResponse.setData(responseData);

        // 2. Mock: retrieveCustomerAccounts 的远程调用
        CustomerAccounts mockCustomerAccounts = new CustomerAccounts();
        List<InvestmentAccount> accList = new ArrayList<>();
        InvestmentAccount acc1 = new InvestmentAccount();
        acc1.setChecksum("chk123");

        // 创建一个与 responseData.getInvestmentAccount().getAccountNumber() 完全匹配的 InvestmentAccountId
        com.hsbc.trade.transfer.domain.account.AccountId investmentAccountId = com.hsbc.trade.transfer.domain.account.AccountId.builder()
                .countryAccountCode("CN")
                .groupMemberAccountCode("G001")
                .accountNumber("987654321") // ✅ 必须和上面 accountId.getAccountNumber() 一致！
                .accountProductTypeCode("01")
                .accountTypeCode("INV")
                .accountCurrencyCode("CNY")
                .build();
        acc1.setInvestmentAccountId(investmentAccountId); // ✅ 设置关联
        accList.add(acc1);
        mockCustomerAccounts.setInvestmentAccountList(accList);

        // 3. Mock: retrieveCustomerNamesWithCinNumber 的远程调用
        PartyNameResponse mockPartyNameResponse = new PartyNameResponse();
        PartyName mockName = new PartyName();
        mockName.setLastName("Doe");
        mockName.setGivenName("John");
        mockName.setCustomerChristianName("Smith");
        mockPartyNameResponse.setName(mockName);

        // 4. Mock: retrieveCustomerPhoneNumberWithCinNumber 的远程调用
        PartyContactResponse mockPartyContactResponse = new PartyContactResponse();
        PartyContact mockContact = new PartyContact();
        mockContact.setMobileNumber1("123456789");
        mockPartyContactResponse.setContact(mockContact);

        // --- CRITICAL: Mock 所有被调用的 restClientService.get(...) ---
        // 1. Mock retrieveTransferDetail 的调用
        String expectedRetrieveDetailUrl = MOCK_TRADE_ONLINE_URL + "/transfers/{transferReferenceNumber}?customerInternalNumber=" + customerInternalNumber + "&sParameterType=SENS";
        when(restClientService.get(
                eq(expectedRetrieveDetailUrl),
                anyMap(),
                eq(RetrieveTransferDetailResponse.class),
                anyInt(),
                anyBoolean()
        )).thenReturn(mockResponse);

        // 2. Mock retrieveCustomerAccounts 的调用
        String expectedAccountsMapUrl = MOCK_ACCOUNTS_MAP_URL + "accounts-map?consumerId=DAC";
        when(restClientService.get(
                eq(expectedAccountsMapUrl),
                anyMap(),
                eq(CustomerAccounts.class),
                anyInt(),
                anyBoolean()
        )).thenReturn(mockCustomerAccounts);

        // 3. Mock retrieveCustomerNamesWithCinNumber 的调用
        String sensitiveDataJson = "[{\"key\":\"SensitiveHeadersKey\",\"value\":\"" + customerInternalNumber + "\"}]";
        String base64SensitiveData = Base64.getEncoder().encodeToString(sensitiveDataJson.getBytes(StandardCharsets.UTF_8));
        Map<String, String> expectedHeadersForCEP = new HashMap<>();
        expectedHeadersForCEP.putAll(baseRequestHeaders);
        expectedHeadersForCEP.remove(HTTPRequestHeaderConstants.X_HSBC_SAML);
        expectedHeadersForCEP.remove(HTTPRequestHeaderConstants.X_HSBC_SAML3);
        expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_E2E_TRUST_TOKEN, "mock-e2e-token");
        expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_GBGF, "");
        expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_SOURCE_SYSTEM_ID, "");
        expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_SENSITIVE_DATA, base64SensitiveData);

        String expectedNameUrl = MOCK_CEP_PARTY_NAME_URL.replace("CIN-SensitiveHeadersKey", customerInternalNumber);
        when(restClientService.get(
                eq(expectedNameUrl),
                argThat(headers -> headers.equals(expectedHeadersForCEP)),
                eq(PartyNameResponse.class),
                anyInt(),
                anyBoolean()
        )).thenReturn(mockPartyNameResponse);

        // 4. Mock retrieveCustomerPhoneNumberWithCinNumber 的调用
        String expectedContactUrl = MOCK_CEP_PARTY_CONTACT_URL.replace("CIN-SensitiveHeadersKey", customerInternalNumber);
        when(restClientService.get(
                eq(expectedContactUrl),
                argThat(headers -> headers.equals(expectedHeadersForCEP)),
                eq(PartyContactResponse.class),
                anyInt(),
                anyBoolean()
        )).thenReturn(mockPartyContactResponse);

        // Act
        RetrieveTransferDetailResponse result = tradeTransferService.retrieveTransferDetail(baseRequestHeaders, transferReferenceNumber);

        // Assert
        assertNotNull(result);
        assertNotNull(result.getData());
        assertNotNull(result.getData().getInvestmentAccount());
        assertEquals("987654321", result.getData().getInvestmentAccount().getAccountNumber());

        // ✅ 验证 checksum 被成功设置
        assertNotNull(result.getData().getAccountChecksumIdentifier());
        assertEquals("chk123", result.getData().getAccountChecksumIdentifier());

        // ✅ 验证 responseDetails 被正确设置
        assertNotNull(result.getResponseDetails());
        assertEquals(0, result.getResponseDetails().getResponseCodeNumber());

        // ✅ 验证所有远程调用都被正确执行
        verify(restClientService, times(1)).get(
                eq(expectedRetrieveDetailUrl),
                anyMap(),
                eq(RetrieveTransferDetailResponse.class),
                anyInt(),
                anyBoolean()
        );
        verify(restClientService, times(1)).get(
                eq(expectedAccountsMapUrl),
                anyMap(),
                eq(CustomerAccounts.class),
                anyInt(),
                anyBoolean()
        );
        verify(restClientService, times(1)).get(
                eq(expectedNameUrl),
                argThat(headers -> headers.equals(expectedHeadersForCEP)),
                eq(PartyNameResponse.class),
                anyInt(),
                anyBoolean()
        );
        verify(restClientService, times(1)).get(
                eq(expectedContactUrl),
                argThat(headers -> headers.equals(expectedHeadersForCEP)),
                eq(PartyContactResponse.class),
                anyInt(),
                anyBoolean()
        );
        verify(e2ETrustTokenUtil, times(2)).getE2ETrustToken();
    }

    @Test
    void retrieveTransferDetail_WithException_ShouldThrowInternalServerError() {
        // Arrange
        String transferReferenceNumber = "TRANSFER123";
        when(restClientService.get(anyString(), anyMap(), eq(RetrieveTransferDetailResponse.class), anyInt(), anyBoolean()))
                .thenThrow(new RuntimeException("Service unavailable"));

        // Act & Assert
        assertThrows(InternalServerErrorException.class, () -> {
            tradeTransferService.retrieveTransferDetail(baseRequestHeaders, transferReferenceNumber);
        });
    }
}
