@ExtendWith(MockitoExtension.class)
class TradeTransferServiceImplTest {

    // ...（原有字段和 @BeforeEach 保持不变）

    // ==================== 新增测试方法 ====================

    @Test
    void retrieveTransferList_withCustomerNameAndContact() {
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        // Mock customer name
        PartyNameResponse partyNameResponse = new PartyNameResponse();
        PartyNameResponse.Name name = new PartyNameResponse.Name();
        name.setLastName("Smith");
        name.setGivenName("John");
        name.setCustomerChristianName("Michael");
        partyNameResponse.setName(name);
        when(retrieveCustomerProfilesService.retrieveCustomerNamesWithCinNumber(any(), any())).thenReturn(partyNameResponse);

        // Mock customer contact
        PartyContactResponse partyContactResponse = new PartyContactResponse();
        PartyContactResponse.Contact contact = new PartyContactResponse.Contact();
        contact.setMobileNumber1("12345678");
        partyContactResponse.setContact(contact);
        when(retrieveCustomerProfilesService.retrieveCustomerPhoneNumberWithCinNumber(any(), any())).thenReturn(partyContactResponse);

        // Mock account list
        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setCountryAccountCode("HK");
        accountId.setGroupMemberAccountCode("HBAP");
        accountId.setAccountNumber("123456");
        accountId.setAccountProductTypeCode("SAV");
        accountId.setAccountTypeCode("01");
        accountId.setAccountCurrencyCode("HKD");

        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(accountId);

        RetrieveCustomerAccountsIdListResponse accountsResponse = new RetrieveCustomerAccountsIdListResponse();
        accountsResponse.setAccountIdList(List.of(accountIdList));
        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(accountsResponse);

        // Mock transfer list response
        RetrieveTransferListResponse response = new RetrieveTransferListResponse();
        RetrieveTransferListResponseData responseData = new RetrieveTransferListResponseData();
        responseData.setTransferLists(new ArrayList<>());
        response.setData(responseData);
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        response.setResponseDetails(responseDetails);

        when(restClientService.get(any(), any(), any(), anyInt(), anyBoolean())).thenReturn(response);

        // 执行：应能正常执行，覆盖 addCustomerNameToUri 和 addCustomerContactToUri
        tradeTransferService.retrieveTransferList(sourceRequestHeader, "ACCEPTED", Collections.singletonList("123"), "1", "PROD1", "PLAIN_TEXT");
    }

    @Test
    void retrieveTransferDetail_accountNotFound() {
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        // Mock account list with no matching account
        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setCountryAccountCode("HK");
        accountId.setGroupMemberAccountCode("HBAP");
        accountId.setAccountNumber("999999"); // 不匹配的账号
        accountId.setAccountProductTypeCode("SAV");
        accountId.setAccountTypeCode("01");
        accountId.setAccountCurrencyCode("HKD");

        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(accountId);

        RetrieveCustomerAccountsIdListResponse accountsResponse = new RetrieveCustomerAccountsIdListResponse();
        accountsResponse.setAccountIdList(List.of(accountIdList));
        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(accountsResponse);

        // Mock transfer detail response
        RetrieveTransferDetailResponse response = new RetrieveTransferDetailResponse();
        RetrieveTransferDetailResponseData data = new RetrieveTransferDetailResponseData();
        data.setInvestmentAccount(new InvestmentAccount());
        data.getInvestmentAccount().setAccountNumber("123456"); // 与上面不匹配
        response.setData(data);
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        response.setResponseDetails(responseDetails);

        when(restClientService.get(any(), any(), any(), anyInt(), anyBoolean())).thenReturn(response);

        // 验证：应抛出 BadRequestException
        assertThrows(BadRequestException.class, () ->
                tradeTransferService.retrieveTransferDetail(sourceRequestHeader, "REF123")
        );
    }

    @Test
    void createTransfer_transferLimitExceeded_Daily() {
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        CreateTransferRequest request = new CreateTransferRequest();
        CreateTransferRequestData data = new CreateTransferRequestData();
        request.setData(data);
        data.setSenderInvestmentAccountChecksumIdentifier("12345");
        ReceiverInfo receiver = new ReceiverInfo();
        receiver.setTransferQuantity(new BigDecimal("1000000")); // 大额
        data.setReceiverLists(List.of(receiver));

        // Mock limit response: daily limit exceeded
        RetrieveTransferLimitResponse limitResponse = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponse.Data limitData = new RetrieveTransferLimitResponse.Data();
        limitData.setAvailableTodayAmount(new BigDecimal("500000")); // 小于请求
        limitData.setMaxDailyLimitedAmount(new BigDecimal("500000"));
        limitData.setAvailableMonthToDateAmount(new BigDecimal("1000000"));
        limitData.setMaxMonthlyLimitedAmount(new BigDecimal("1000000"));
        limitData.setAvailableYearToDateAmount(new BigDecimal("1000000"));
        limitData.setMaxYearlyLimitedAmount(new BigDecimal("1000000"));
        limitResponse.setData(limitData);

        when(tradeLimitService.retrieveLimitations(any())).thenReturn(limitResponse);

        // Mock account
        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setCountryAccountCode("HK");
        accountId.setGroupMemberAccountCode("HBAP");
        accountId.setAccountNumber("123456");
        accountId.setAccountProductTypeCode("SAV");
        accountId.setAccountTypeCode("01");
        accountId.setAccountCurrencyCode("HKD");

        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(accountId);

        RetrieveCustomerAccountsIdListResponse accountsResponse = new RetrieveCustomerAccountsIdListResponse();
        accountsResponse.setAccountIdList(List.of(accountIdList));
        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(accountsResponse);

        // Mock SRE
        RuleResponse sreResponse = new RuleResponse();
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        sreResponse.setResponseDetails(responseDetails);
        when(sreValidationService.callSreForTransferValidation(any(), any(), any(), any())).thenReturn(sreResponse);

        // 验证：应抛出 TransferLimitExceededException
        assertThrows(TransferLimitExceededException.class, () ->
                tradeTransferService.createTransfers(sourceRequestHeader, request)
        );
    }

    @Test
    void createTransfer_transferLimitExceeded_Monthly() {
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        CreateTransferRequest request = new CreateTransferRequest();
        CreateTransferRequestData data = new CreateTransferRequestData();
        request.setData(data);
        data.setSenderInvestmentAccountChecksumIdentifier("12345");
        ReceiverInfo receiver = new ReceiverInfo();
        receiver.setTransferQuantity(new BigDecimal("1000000"));
        data.setReceiverLists(List.of(receiver));

        RetrieveTransferLimitResponse limitResponse = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponse.Data limitData = new RetrieveTransferLimitResponse.Data();
        limitData.setAvailableTodayAmount(new BigDecimal("1000000"));
        limitData.setMaxDailyLimitedAmount(new BigDecimal("1000000"));
        limitData.setAvailableMonthToDateAmount(new BigDecimal("500000")); // 超出
        limitData.setMaxMonthlyLimitedAmount(new BigDecimal("500000"));
        limitData.setAvailableYearToDateAmount(new BigDecimal("1000000"));
        limitData.setMaxYearlyLimitedAmount(new BigDecimal("1000000"));
        limitResponse.setData(limitData);

        when(tradeLimitService.retrieveLimitations(any())).thenReturn(limitResponse);

        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setCountryAccountCode("HK");
        accountId.setGroupMemberAccountCode("HBAP");
        accountId.setAccountNumber("123456");
        accountId.setAccountProductTypeCode("SAV");
        accountId.setAccountTypeCode("01");
        accountId.setAccountCurrencyCode("HKD");

        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(accountId);

        RetrieveCustomerAccountsIdListResponse accountsResponse = new RetrieveCustomerAccountsIdListResponse();
        accountsResponse.setAccountIdList(List.of(accountIdList));
        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(accountsResponse);

        RuleResponse sreResponse = new RuleResponse();
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        sreResponse.setResponseDetails(responseDetails);
        when(sreValidationService.callSreForTransferValidation(any(), any(), any(), any())).thenReturn(sreResponse);

        assertThrows(TransferLimitExceededException.class, () ->
                tradeTransferService.createTransfers(sourceRequestHeader, request)
        );
    }

    @Test
    void createTransfer_transferLimitExceeded_Yearly() {
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        CreateTransferRequest request = new CreateTransferRequest();
        CreateTransferRequestData data = new CreateTransferRequestData();
        request.setData(data);
        data.setSenderInvestmentAccountChecksumIdentifier("12345");
        ReceiverInfo receiver = new ReceiverInfo();
        receiver.setTransferQuantity(new BigDecimal("1000000"));
        data.setReceiverLists(List.of(receiver));

        RetrieveTransferLimitResponse limitResponse = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponse.Data limitData = new RetrieveTransferLimitResponse.Data();
        limitData.setAvailableTodayAmount(new BigDecimal("1000000"));
        limitData.setMaxDailyLimitedAmount(new BigDecimal("1000000"));
        limitData.setAvailableMonthToDateAmount(new BigDecimal("1000000"));
        limitData.setMaxMonthlyLimitedAmount(new BigDecimal("1000000"));
        limitData.setAvailableYearToDateAmount(new BigDecimal("500000")); // 超出
        limitData.setMaxYearlyLimitedAmount(new BigDecimal("500000"));
        limitResponse.setData(limitData);

        when(tradeLimitService.retrieveLimitations(any())).thenReturn(limitResponse);

        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setCountryAccountCode("HK");
        accountId.setGroupMemberAccountCode("HBAP");
        accountId.setAccountNumber("123456");
        accountId.setAccountProductTypeCode("SAV");
        accountId.setAccountTypeCode("01");
        accountId.setAccountCurrencyCode("HKD");

        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(accountId);

        RetrieveCustomerAccountsIdListResponse accountsResponse = new RetrieveCustomerAccountsIdListResponse();
        accountsResponse.setAccountIdList(List.of(accountIdList));
        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(accountsResponse);

        RuleResponse sreResponse = new RuleResponse();
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        sreResponse.setResponseDetails(responseDetails);
        when(sreValidationService.callSreForTransferValidation(any(), any(), any(), any())).thenReturn(sreResponse);

        assertThrows(TransferLimitExceededException.class, () ->
                tradeTransferService.createTransfers(sourceRequestHeader, request)
        );
    }

    @Test
    void createTransfer_handleDOperationResponse_withGoldPrice() {
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        CreateTransferRequest request = new CreateTransferRequest();
        CreateTransferRequestData data = new CreateTransferRequestData();
        data.setActionRequestCode(ActionRequestCode.D); // 关键：D 操作
        data.setSenderInvestmentAccountChecksumIdentifier("12345");
        ReceiverInfo receiver = new ReceiverInfo();
        receiver.setTransferQuantity(new BigDecimal("1"));
        data.setReceiverLists(List.of(receiver));
        request.setData(data);

        // Mock gold price
        GoldPriceResponse goldPriceResponse = new GoldPriceResponse();
        GoldPriceResponseData mdsData = new GoldPriceResponseData();
        mdsData.setGoldPriceAmount(new BigDecimal("1234.56"));
        mdsData.setPublishTime("2025-11-20T10:00:00Z");
        goldPriceResponse.setData(mdsData);
        when(restClientService.get(anyString(), any(), eq(GoldPriceResponse.class), anyInt(), anyBoolean()))
                .thenReturn(goldPriceResponse);

        // Mock account
        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setCountryAccountCode("HK");
        accountId.setGroupMemberAccountCode("HBAP");
        accountId.setAccountNumber("123456");
        accountId.setAccountProductTypeCode("SAV");
        accountId.setAccountTypeCode("01");
        accountId.setAccountCurrencyCode("HKD");

        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(accountId);

        RetrieveCustomerAccountsIdListResponse accountsResponse = new RetrieveCustomerAccountsIdListResponse();
        accountsResponse.setAccountIdList(List.of(accountIdList));
        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(accountsResponse);

        // Mock SRE
        RuleResponse sreResponse = new RuleResponse();
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        sreResponse.setResponseDetails(responseDetails);
        when(sreValidationService.callSreForTransferValidation(any(), any(), any(), any())).thenReturn(sreResponse);

        // Mock duplicate key
        when(duplicateSubmitPreventionService.generateUniqueKey()).thenReturn("unique-key-123");

        // Mock response with transfer order list
        CreateTransferResponse response = new CreateTransferResponse();
        CreateTransferResponse.Data responseData = new CreateTransferResponse.Data();
        List<TransferOrderInfo> orderList = new ArrayList<>();
        TransferOrderInfo orderInfo = new TransferOrderInfo();
        orderList.add(orderInfo);
        responseData.setTransferOrderLists(orderList);
        response.setData(responseData);

        ResponseDetails respDetails = new ResponseDetails();
        respDetails.setResponseCodeNumber(0);
        response.setResponseDetails(respDetails);

        when(restClientService.post(any(), any(), any(), any(), anyInt(), anyBoolean())).thenReturn(response);

        // Mock customer name
        PartyNameResponse partyNameResponse = new PartyNameResponse();
        PartyNameResponse.Name name = new PartyNameResponse.Name();
        name.setLastName("Smith");
        name.setGivenName("John");
        name.setCustomerChristianName("Michael");
        partyNameResponse.setName(name);
        when(retrieveCustomerProfilesService.retrieveCustomerNamesWithCinNumber(any(), any())).thenReturn(partyNameResponse);

        // 执行
        CreateTransferResponse result = tradeTransferService.createTransfers(sourceRequestHeader, request);

        // 验证：D操作应设置金价和唯一键
        assertNotNull(result.getData().getRequestUniqueKey());
        assertEquals("1234.56", result.getData().getTransferOrderLists().get(0).getRequestPriceValue().toString());
        assertEquals("HKD", result.getData().getTransferOrderLists().get(0).getPriceCurrencyCode());
        assertEquals("2025-11-20T10:00:00Z", result.getData().getTransferOrderLists().get(0).getRequestPriceAsOfDateTime());
    }

    @Test
    void setSenderFullName_withNullFields() {
        // 通过反射调用私有方法
        PartyNameResponse partyNameResponse = new PartyNameResponse();
        PartyNameResponse.Name name = new PartyNameResponse.Name();
        name.setLastName(null);
        name.setGivenName("");
        name.setCustomerChristianName("Michael");
        partyNameResponse.setName(name);

        CreateTransferResponse createTransferResponse = new CreateTransferResponse();
        CreateTransferResponse.Data data = new CreateTransferResponse.Data();
        createTransferResponse.setData(data);

        // 使用反射调用私有方法
        try {
            Method method = TradeTransferServiceImpl.class.getDeclaredMethod("setSenderFullName", CreateTransferResponse.class, PartyNameResponse.class);
            method.setAccessible(true);
            method.invoke(tradeTransferService, createTransferResponse, partyNameResponse);
        } catch (Exception e) {
            fail("反射调用失败: " + e.getMessage());
        }

        // 验证：应拼接为 "Michael"（仅非空字段）
        assertEquals("Michael", createTransferResponse.getData().getSenderCustomerName());
    }

    @Test
    void modifyTransfer_rejectAction() {
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        UpdateTransferRequest request = new UpdateTransferRequest();
        UpdateTransferRequestData data = new UpdateTransferRequestData();
        request.setData(data);
        data.setTransferActionCode(TransferActionCode.R); // REJECT 路径
        data.setReceiverInvestmentAccountChecksumIdentifier("12345");

        // Mock account
        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setCountryAccountCode("HK");
        accountId.setGroupMemberAccountCode("HBAP");
        accountId.setAccountNumber("123456");
        accountId.setAccountProductTypeCode("SAV");
        accountId.setAccountTypeCode("01");
        accountId.setAccountCurrencyCode("HKD");

        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(accountId);

        RetrieveCustomerAccountsIdListResponse accountsResponse = new RetrieveCustomerAccountsIdListResponse();
        accountsResponse.setAccountIdList(List.of(accountIdList));
        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(accountsResponse);

        // Mock SRE (should not be called for R)
        RuleResponse sreResponse = new RuleResponse();
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        sreResponse.setResponseDetails(responseDetails);
        when(sreValidationService.callSreForTransferValidation(any(), any(), any(), any())).thenReturn(sreResponse);

        // Mock gold price (should not be called for R)
        GoldPriceResponse goldPriceResponse = new GoldPriceResponse();
        when(restClientService.get(anyString(), any(), eq(GoldPriceResponse.class), anyInt(), anyBoolean()))
                .thenReturn(goldPriceResponse);

        UpdateTransferResponse mockUpdateTransferResponse = new UpdateTransferResponse();
        ResponseDetails respDetails = new ResponseDetails();
        respDetails.setResponseCodeNumber(0);
        mockUpdateTransferResponse.setResponseDetails(respDetails);

        when(restClientService.put(any(), any(), any(), any(), anyInt(), anyBoolean())).thenReturn(mockUpdateTransferResponse);

        // 执行：应走 R 路径，不调用 SRE 或金价
        tradeTransferService.modifyTransfers(sourceRequestHeader, request);
    }

    @Test
    void maskNamesInResponse_reflectionException() {
        // 模拟一个对象，其 getter/setter 方法名不存在，触发反射异常
        Object mockObject = new Object() {
            public String getSenderCustomerFirstName() { return "John"; }
            public String getSenderCustomerMiddleName() { return "Michael"; }
            // 没有 setSenderCustomerFirstName / setSenderCustomerMiddleName
        };

        // 调用方法：应捕获异常并记录日志，不抛出
        tradeTransferService.maskFirstNameAndMiddleName(mockObject, "senderCustomerFirstName", "senderCustomerMiddleName");
        // 无异常即通过，日志由 log4j 记录，无需断言
    }

    @Test
    void validateSreForReceivers_withNullReceiverCin() {
        List<ReceiverInfo> receivers = new ArrayList<>();
        ReceiverInfo receiver = new ReceiverInfo();
        receiver.setReceiverCustomerNumber(null); // 触发无CIN规则
        receivers.add(receiver);

        // Mock SRE call with no CIN rule
        RuleResponse sreResponse = new RuleResponse();
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        sreResponse.setResponseDetails(responseDetails);
        when(sreValidationService.callSreForTransferValidation(
                eq("dac_tokenized_gold_transfer_sender_rule_without_cin"),
                any(), any(), any())).thenReturn(sreResponse);

        tradeTransferService.validateSreForReceivers(receivers, "CIN123", Collections.emptyMap());

        // 验证：调用了无CIN规则
        verify(sreValidationService).callSreForTransferValidation(
                eq("dac_tokenized_gold_transfer_sender_rule_without_cin"),
                eq("CIN123"), eq(null), any());
    }

    @Test
    void extractAccountIdMap_withNullAccountList() {
        CustomerAccounts customerAccounts = new CustomerAccounts();
        customerAccounts.setInvestmentAccountList(null);
        Map<String, String> result = tradeTransferService.extractAccountIdMap(customerAccounts);
        assertTrue(result.isEmpty());
    }

    @Test
    void extractAccountIdMap_withEmptyAccountList() {
        CustomerAccounts customerAccounts = new CustomerAccounts();
        customerAccounts.setInvestmentAccountList(new ArrayList<>());
        Map<String, String> result = tradeTransferService.extractAccountIdMap(customerAccounts);
        assertTrue(result.isEmpty());
    }

    @Test
    void retrieveAccountIdWithCheckSum() {
        // 模拟 restClientService 调用返回 AccountId
        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setCountryAccountCode("HK");
        accountId.setGroupMemberAccountCode("HBAP");
        accountId.setAccountNumber("123456");
        accountId.setAccountProductTypeCode("SAV");
        accountId.setAccountTypeCode("01");
        accountId.setAccountCurrencyCode("HKD");

        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(accountId);

        RetrieveCustomerAccountsIdListResponse response = new RetrieveCustomerAccountsIdListResponse();
        response.setAccountIdList(List.of(accountIdList));

        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(response);

        Map<String, String> headers = new HashMap<>();
        headers.put(TransferQueryParameterConstant.CHECKSUM, "12345");

        // 调用私有方法：需要反射
        try {
            Method method = TradeTransferServiceImpl.class.getDeclaredMethod("retrieveAccountIdWithCheckSum", Map.class);
            method.setAccessible(true);
            AccountId result = (AccountId) method.invoke(tradeTransferService, headers);
            assertNotNull(result);
            assertEquals("123456", result.getAccountNumber());
        } catch (Exception e) {
            fail("反射调用失败: " + e.getMessage());
        }
    }
}
