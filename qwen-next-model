@Test
void retrieveTransferDetail_Success() {
    // Arrange
    String transferReferenceNumber = "TRANSFER123";

    // 1. Mock: retrieveTransferDetail Response - CRITICAL: Ensure responseDetails is set!
    RetrieveTransferDetailResponse mockResponse = new RetrieveTransferDetailResponse();
    RetrieveTransferDetailResponseData responseData = new RetrieveTransferDetailResponseData();

    // 设置投资账户信息（业务逻辑需要）
    AccountId accountId = new AccountId();
    accountId.setAccountNumber("123456789");
    responseData.setInvestmentAccount(accountId);

    // ✅ 关键修复：设置 responseDetails！这是 ResponseInfoHandler.prepareResponse 所必需的
    ResponseDetails responseDetails = new ResponseDetails();
    responseDetails.setResponseCodeNumber(0); // ✅ 成功状态码，必须设置！
    responseDetails.setReasonCodes(Collections.emptyList()); // ✅ 避免空指针
    responseDetails.setWarnings(Collections.emptyList()); // ✅ 避免空指针
    responseDetails.setErrorInfos(Collections.emptyList()); // ✅ 避免空指针
    responseData.setResponseDetails(responseDetails); // ✅ 将 responseDetails 设置到 data 中

    mockResponse.setData(responseData); // ✅ 将 data 设置到 response 上！（这是之前缺失的关键一步）

    // 2. Mock: CustomerAccounts for extractAccountIdMap (must be valid to pass the check)
    CustomerAccounts mockCustomerAccounts = new CustomerAccounts();
    List<InvestmentAccount> accList = new ArrayList<>();
    InvestmentAccount acc1 = new InvestmentAccount();
    acc1.setChecksum("chk123");

    // 使用正确的包路径下的 AccountId
    com.hsbc.trade.transfer.domain.account.AccountId investmentAccountId = com.hsbc.trade.transfer.domain.account.AccountId.builder()
            .countryAccountCode("CN")
            .groupMemberAccountCode("G001")
            .accountNumber("123456789") // ✅ 这个 accountNumber 必须和 responseData.getInvestmentAccount().getAccountNumber() 一致！
            .accountProductTypeCode("01")
            .accountTypeCode("INV")
            .accountCurrencyCode("CNY")
            .build();

    acc1.setInvestmentAccountId(investmentAccountId); // ✅ 设置关联
    accList.add(acc1);

    mockCustomerAccounts.setInvestmentAccountList(accList); // ✅ 设置非空列表

    // 3. Mock: PartyNameResponse for addCustomerNameToUri (getName() != null path)
    PartyNameResponse mockPartyNameResponse = new PartyNameResponse();
    PartyName mockName = new PartyName();
    mockName.setLastName("Doe");
    mockName.setGivenName("John");
    mockName.setCustomerChristianName("Smith");
    mockPartyNameResponse.setName(mockName); // getName() will return this non-null object

    // 4. Mock: PartyContactResponse for addCustomerContactToUri (getContact() != null path)
    PartyContactResponse mockPartyContactResponse = new PartyContactResponse();
    PartyContact mockContact = new PartyContact();
    mockContact.setMobileNumber1("123456789");
    mockPartyContactResponse.setContact(mockContact); // getContact() will return this non-null object

    // --- CRITICAL: Mock the specific restClientService.get calls with exact URLs and headers ---

    // 1. Call for retrieveTransferDetail itself
    when(restClientService.get(
            eq(MOCK_TRADE_ONLINE_URL + "/transfers/{transferReferenceNumber}?customerInternalNumber=" + sourceRequestHeader.get(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID) + "&sParameterType=SENS"),
            anyMap(),
            eq(RetrieveTransferDetailResponse.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(mockResponse);

    // 2. Call for retrieveCustomerAccounts (inside retrieveTransferDetail)
    when(restClientService.get(
            eq(MOCK_ACCOUNTS_MAP_URL + "accounts-map?consumerId=DAC"),
            anyMap(),
            eq(CustomerAccounts.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(mockCustomerAccounts);

    // 3. Call for retrieveCustomerNamesWithCinNumber (inside addCustomerNameToUri)
    String sensitiveDataJson = "[{\"key\":\"SensitiveHeadersKey\",\"value\":\"" + sourceRequestHeader.get(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID) + "\"}]";
    String base64SensitiveData = Base64.getEncoder().encodeToString(sensitiveDataJson.getBytes(StandardCharsets.UTF_8));

    Map<String, String> expectedHeadersForCEP = new HashMap<>();
    expectedHeadersForCEP.putAll(sourceRequestHeader);
    expectedHeadersForCEP.remove(HTTPRequestHeaderConstants.X_HSBC_SAML);
    expectedHeadersForCEP.remove(HTTPRequestHeaderConstants.X_HSBC_SAML3);
    expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_E2E_TRUST_TOKEN, "e2e-token");
    expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_GBGF, "");
    expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_SOURCE_SYSTEM_ID, "");
    expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_SENSITIVE_DATA, base64SensitiveData);

    String expectedNameUrl = MOCK_CEP_PARTY_NAME_URL.replace("CIN-SensitiveHeadersKey", sourceRequestHeader.get(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID));
    when(restClientService.get(
            eq(expectedNameUrl),
            argThat(headers -> headers.equals(expectedHeadersForCEP)),
            eq(PartyNameResponse.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(mockPartyNameResponse);

    // 4. Call for retrieveCustomerPhoneNumberWithCinNumber (inside addCustomerContactToUri)
    String expectedContactUrl = MOCK_CEP_PARTY_CONTACT_URL.replace("CIN-SensitiveHeadersKey", sourceRequestHeader.get(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID));
    when(restClientService.get(
            eq(expectedContactUrl),
            argThat(headers -> headers.equals(expectedHeadersForCEP)),
            eq(PartyContactResponse.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(mockPartyContactResponse);

    // Mock E2E token generation for updateHeaderforCEP calls
    when(e2ETrustTokenUtil.getE2ETrustToken()).thenReturn("e2e-token");

    // Act
    RetrieveTransferDetailResponse result = tradeTransferService.retrieveTransferDetail(
            sourceRequestHeader, transferReferenceNumber);

    // Assert
    assertNotNull(result);
    assertNotNull(result.getData());
    assertNotNull(result.getData().getInvestmentAccount());
    assertEquals("123456789", result.getData().getInvestmentAccount().getAccountNumber());

    // ✅ 验证 checksum 被成功设置
    assertNotNull(result.getData().getAccountChecksumIdentifier());
    assertEquals("chk123", result.getData().getAccountChecksumIdentifier());

    // ✅ 验证 responseDetails 被正确设置
    assertNotNull(result.getResponseDetails());
    assertEquals(0, result.getResponseDetails().getResponseCodeNumber());

    // Verify the specific interactions happened
    verify(restClientService, times(1)).get(
            eq(MOCK_TRADE_ONLINE_URL + "/transfers/{transferReferenceNumber}?customerInternalNumber=" + sourceRequestHeader.get(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID) + "&sParameterType=SENS"),
            anyMap(),
            eq(RetrieveTransferDetailResponse.class),
            anyInt(),
            anyBoolean()
    );
    verify(restClientService, times(1)).get(
            eq(MOCK_ACCOUNTS_MAP_URL + "accounts-map?consumerId=DAC"),
            anyMap(),
            eq(CustomerAccounts.class),
            anyInt(),
            anyBoolean()
    );
    verify(restClientService, times(1)).get(
            eq(expectedNameUrl),
            argThat(headers -> headers.equals(expectedHeadersForCEP)),
            eq(PartyNameResponse.class),
            anyInt(),
            anyBoolean()
    );
    verify(restClientService, times(1)).get(
            eq(expectedContactUrl),
            argThat(headers -> headers.equals(expectedHeadersForCEP)),
            eq(PartyContactResponse.class),
            anyInt(),
            anyBoolean()
    );
    verify(e2ETrustTokenUtil, times(2)).getE2ETrustToken();
}
