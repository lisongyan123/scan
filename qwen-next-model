@Test
void testRetrieveLimitations_nullResponse_throwsInternalServerError() {
    // 模拟 restClientService 返回 null
    lenient().when(restClientService.get(anyString(), anyMap(), eq(LimitEnquiryResponse.class), anyInt(), anyBoolean()))
            .thenReturn(null);

    assertThrows(InternalServerErrorException.class, () -> tradeLimitService.retrieveLimitations(headers));
}

@Test
void testRetrieveLimitations_nullCbHkHbapObsShrdClcTranLmtEnqWpbSrvOperationResponse() {
    // 构造一个响应，但其核心结构为 null
    LimitEnquiryResponse limitEnquiryResponse = mock(LimitEnquiryResponse.class);
    lenient().when(limitEnquiryResponse.getCbHkHbapObsShrdClcTranLmtEnqWpbSrvOperationResponse()).thenReturn(null);

    lenient().when(restClientService.get(anyString(), anyMap(), eq(LimitEnquiryResponse.class), anyInt(), anyBoolean()))
            .thenReturn(limitEnquiryResponse);

    RetrieveTransferAmountResponse transferAmountResponse = new RetrieveTransferAmountResponse();
    RetrieveTransferAmountResponseData data = new RetrieveTransferAmountResponseData();
    data.setMonthlyTransferCount(0);
    data.setMonthlyTransferAmount(BigDecimal.ZERO);
    data.setYearlyTransferAmount(BigDecimal.ZERO);
    transferAmountResponse.setData(data);

    lenient().when(restClientService.get(contains("/trade-amount"), anyMap(), eq(RetrieveTransferAmountResponse.class), anyInt(), anyBoolean()))
            .thenReturn(transferAmountResponse);

    lenient().when(customerLimitConfig.getDailyAmount()).thenReturn(BigDecimal.valueOf(1000));
    lenient().when(customerLimitConfig.getMonthlyAmount()).thenReturn(BigDecimal.valueOf(5000));
    lenient().when(customerLimitConfig.getYearlyAmount()).thenReturn(BigDecimal.valueOf(10000));
    lenient().when(customerLimitConfig.getMonthlyCount()).thenReturn(10);

    RetrieveTransferLimitResponse response = tradeLimitService.retrieveLimitations(headers);
    assertThat(response.getData().getAvailableTodayAmount()).isEqualTo(BigDecimal.ZERO); // 应该为0，不抛异常
}

@Test
void testRetrieveLimitations_emptyTransactionDetailList() {
    // 构造响应：有结构，但 transactionLimitDetailList 为空
    LimitEnquiryResponse limitEnquiryResponse = mock(LimitEnquiryResponse.class);
    LimitEnquiryResponsePayload payload = new LimitEnquiryResponsePayload();
    LimitEnquiryResponseWork work = new LimitEnquiryResponseWork();
    LimitEnquiryResponseDataWrapper responseWorkRecord = new LimitEnquiryResponseDataWrapper();
    responseWorkRecord.setTransactionLimitDetail(new ArrayList<>()); // 空列表

    work.setResponseWorkRecord(responseWorkRecord);
    payload.setResponseWork(work);
    limitEnquiryResponseDataWrapper.setResponsePayload(payload);
    lenient().when(limitEnquiryResponse.getCbHkHbapObsShrdClcTranLmtEnqWpbSrvOperationResponse()).thenReturn(limitEnquiryResponseDataWrapper);

    lenient().when(restClientService.get(anyString(), anyMap(), eq(LimitEnquiryResponse.class), anyInt(), anyBoolean()))
            .thenReturn(limitEnquiryResponse);

    // 模拟交易金额查询
    RetrieveTransferAmountResponse transferAmountResponse = new RetrieveTransferAmountResponse();
    RetrieveTransferAmountResponseData data = new RetrieveTransferAmountResponseData();
    data.setMonthlyTransferCount(0);
    data.setMonthlyTransferAmount(BigDecimal.ZERO);
    data.setYearlyTransferAmount(BigDecimal.ZERO);
    transferAmountResponse.setData(data);

    lenient().when(restClientService.get(contains("/trade-amount"), anyMap(), eq(RetrieveTransferAmountResponse.class), anyInt(), anyBoolean()))
            .thenReturn(transferAmountResponse);

    lenient().when(customerLimitConfig.getDailyAmount()).thenReturn(BigDecimal.valueOf(1000));
    lenient().when(customerLimitConfig.getMonthlyAmount()).thenReturn(BigDecimal.valueOf(5000));
    lenient().when(customerLimitConfig.getYearlyAmount()).thenReturn(BigDecimal.valueOf(10000));
    lenient().when(customerLimitConfig.getMonthlyCount()).thenReturn(10);

    RetrieveTransferLimitResponse response = tradeLimitService.retrieveLimitations(headers);
    assertThat(response.getData().getAvailableTodayAmount()).isEqualTo(BigDecimal.ZERO);
}

@Test
void testRetrieveLimitations_noP2PSLimitDetail() {
    // 构造响应：有 transactionLimitDetailList，但没有 P2PS 类型
    LimitEnquiryResponse limitEnquiryResponse = mock(LimitEnquiryResponse.class);
    LimitEnquiryResponsePayload payload = new LimitEnquiryResponsePayload();
    LimitEnquiryResponseWork work = new LimitEnquiryResponseWork();
    LimitEnquiryResponseDataWrapper responseWorkRecord = new LimitEnquiryResponseDataWrapper();

    List<TransactionLimitDetailList> details = new ArrayList<>();
    TransactionLimitDetailList otherDetail = new TransactionLimitDetailList();
    otherDetail.setLimitType("OTHER"); // 非 P2PS
    details.add(otherDetail);
    responseWorkRecord.setTransactionLimitDetail(details);

    work.setResponseWorkRecord(responseWorkRecord);
    payload.setResponseWork(work);
    limitEnquiryResponseDataWrapper.setResponsePayload(payload);
    lenient().when(limitEnquiryResponse.getCbHkHbapObsShrdClcTranLmtEnqWpbSrvOperationResponse()).thenReturn(limitEnquiryResponseDataWrapper);

    lenient().when(restClientService.get(anyString(), anyMap(), eq(LimitEnquiryResponse.class), anyInt(), anyBoolean()))
            .thenReturn(limitEnquiryResponse);

    // 模拟交易金额查询
    RetrieveTransferAmountResponse transferAmountResponse = new RetrieveTransferAmountResponse();
    RetrieveTransferAmountResponseData data = new RetrieveTransferAmountResponseData();
    data.setMonthlyTransferCount(0);
    data.setMonthlyTransferAmount(BigDecimal.ZERO);
    data.setYearlyTransferAmount(BigDecimal.ZERO);
    transferAmountResponse.setData(data);

    lenient().when(restClientService.get(contains("/trade-amount"), anyMap(), eq(RetrieveTransferAmountResponse.class), anyInt(), anyBoolean()))
            .thenReturn(transferAmountResponse);

    lenient().when(customerLimitConfig.getDailyAmount()).thenReturn(BigDecimal.valueOf(1000));
    lenient().when(customerLimitConfig.getMonthlyAmount()).thenReturn(BigDecimal.valueOf(5000));
    lenient().when(customerLimitConfig.getYearlyAmount()).thenReturn(BigDecimal.valueOf(10000));
    lenient().when(customerLimitConfig.getMonthlyCount()).thenReturn(10);

    RetrieveTransferLimitResponse response = tradeLimitService.retrieveLimitations(headers);
    assertThat(response.getData().getAvailableTodayAmount()).isEqualTo(BigDecimal.ZERO);
}

@Test
void testRetrieveLimitations_utilizedLimitAmountIsNull() {
    // 构造响应：有 P2PS，但 utilizedLimitAmount 为 null
    LimitEnquiryResponse limitEnquiryResponse = mock(LimitEnquiryResponse.class);
    LimitEnquiryResponsePayload payload = new LimitEnquiryResponsePayload();
    LimitEnquiryResponseWork work = new LimitEnquiryResponseWork();
    LimitEnquiryResponseDataWrapper responseWorkRecord = new LimitEnquiryResponseDataWrapper();

    List<TransactionLimitDetailList> details = new ArrayList<>();
    TransactionLimitDetailList detail = new TransactionLimitDetailList();
    detail.setLimitType("P2PS");
    detail.setUtilizedLimitAmount(null); // 关键：null
    detail.setCurrentLimitAmount(new CurrentLimitAmount());
    detail.getCurrentLimitAmount().setCurrentLimitAmountValue(1000);
    detail.getCurrentLimitAmount().setCurrentLimitAmountDecimal(2);
    details.add(detail);

    responseWorkRecord.setTransactionLimitDetail(details);
    work.setResponseWorkRecord(responseWorkRecord);
    payload.setResponseWork(work);
    limitEnquiryResponseDataWrapper.setResponsePayload(payload);
    lenient().when(limitEnquiryResponse.getCbHkHbapObsShrdClcTranLmtEnqWpbSrvOperationResponse()).thenReturn(limitEnquiryResponseDataWrapper);

    lenient().when(restClientService.get(anyString(), anyMap(), eq(LimitEnquiryResponse.class), anyInt(), anyBoolean()))
            .thenReturn(limitEnquiryResponse);

    // 模拟交易金额查询
    RetrieveTransferAmountResponse transferAmountResponse = new RetrieveTransferAmountResponse();
    RetrieveTransferAmountResponseData data = new RetrieveTransferAmountResponseData();
    data.setMonthlyTransferCount(0);
    data.setMonthlyTransferAmount(BigDecimal.ZERO);
    data.setYearlyTransferAmount(BigDecimal.ZERO);
    transferAmountResponse.setData(data);

    lenient().when(restClientService.get(contains("/trade-amount"), anyMap(), eq(RetrieveTransferAmountResponse.class), anyInt(), anyBoolean()))
            .thenReturn(transferAmountResponse);

    lenient().when(customerLimitConfig.getDailyAmount()).thenReturn(BigDecimal.valueOf(1000));
    lenient().when(customerLimitConfig.getMonthlyAmount()).thenReturn(BigDecimal.valueOf(5000));
    lenient().when(customerLimitConfig.getYearlyAmount()).thenReturn(BigDecimal.valueOf(10000));
    lenient().when(customerLimitConfig.getMonthlyCount()).thenReturn(10);

    RetrieveTransferLimitResponse response = tradeLimitService.retrieveLimitations(headers);
    assertThat(response.getData().getAvailableTodayAmount()).isEqualTo(BigDecimal.valueOf(1000)); // 全部可用
}

@Test
void testRetrieveLimitations_currentLimitAmountIsNull() {
    // 构造响应：有 P2PS，但 currentLimitAmount 为 null
    LimitEnquiryResponse limitEnquiryResponse = mock(LimitEnquiryResponse.class);
    LimitEnquiryResponsePayload payload = new LimitEnquiryResponsePayload();
    LimitEnquiryResponseWork work = new LimitEnquiryResponseWork();
    LimitEnquiryResponseDataWrapper responseWorkRecord = new LimitEnquiryResponseDataWrapper();

    List<TransactionLimitDetailList> details = new ArrayList<>();
    TransactionLimitDetailList detail = new TransactionLimitDetailList();
    detail.setLimitType("P2PS");
    detail.setCurrentLimitAmount(null); // 关键：null
    detail.setUtilizedLimitAmount(new UtilizedLimitAmount());
    detail.getUtilizedLimitAmount().setUtilizedLimitAmountValue(100);
    detail.getUtilizedLimitAmount().setUtilizedLimitAmountDecimal(2);
    details.add(detail);

    responseWorkRecord.setTransactionLimitDetail(details);
    work.setResponseWorkRecord(responseWorkRecord);
    payload.setResponseWork(work);
    limitEnquiryResponseDataWrapper.setResponsePayload(payload);
    lenient().when(limitEnquiryResponse.getCbHkHbapObsShrdClcTranLmtEnqWpbSrvOperationResponse()).thenReturn(limitEnquiryResponseDataWrapper);

    lenient().when(restClientService.get(anyString(), anyMap(), eq(LimitEnquiryResponse.class), anyInt(), anyBoolean()))
            .thenReturn(limitEnquiryResponse);

    // 模拟交易金额查询
    RetrieveTransferAmountResponse transferAmountResponse = new RetrieveTransferAmountResponse();
    RetrieveTransferAmountResponseData data = new RetrieveTransferAmountResponseData();
    data.setMonthlyTransferCount(0);
    data.setMonthlyTransferAmount(BigDecimal.ZERO);
    data.setYearlyTransferAmount(BigDecimal.ZERO);
    transferAmountResponse.setData(data);

    lenient().when(restClientService.get(contains("/trade-amount"), anyMap(), eq(RetrieveTransferAmountResponse.class), anyInt(), anyBoolean()))
            .thenReturn(transferAmountResponse);

    lenient().when(customerLimitConfig.getDailyAmount()).thenReturn(BigDecimal.valueOf(1000));
    lenient().when(customerLimitConfig.getMonthlyAmount()).thenReturn(BigDecimal.valueOf(5000));
    lenient().when(customerLimitConfig.getYearlyAmount()).thenReturn(BigDecimal.valueOf(10000));
    lenient().when(customerLimitConfig.getMonthlyCount()).thenReturn(10);

    RetrieveTransferLimitResponse response = tradeLimitService.retrieveLimitations(headers);
    assertThat(response.getData().getAvailableTodayAmount()).isEqualTo(BigDecimal.ZERO); // 无上限，可用为0
}

@Test
void testRetrieveLimitations_retrieveTransferAmountThrowsException() {
    // 模拟 retrieveTransferAmount 抛异常
    lenient().when(restClientService.get(contains("/trade-amount"), anyMap(), eq(RetrieveTransferAmountResponse.class), anyInt(), anyBoolean()))
            .thenThrow(new RuntimeException("SRBP service down"));

    lenient().when(customerLimitConfig.getDailyAmount()).thenReturn(BigDecimal.valueOf(1000));
    lenient().when(customerLimitConfig.getMonthlyAmount()).thenReturn(BigDecimal.valueOf(5000));
    lenient().when(customerLimitConfig.getYearlyAmount()).thenReturn(BigDecimal.valueOf(10000));
    lenient().when(customerLimitConfig.getMonthlyCount()).thenReturn(10);

    assertThrows(InternalServerErrorException.class, () -> tradeLimitService.retrieveLimitations(headers));
}

@Test
void testRetrieveLimitations_requestHeaderMissingCustomerId() {
    // 请求头中没有 X_HSBC_Customer_Id
    Map<String, String> headersWithoutCustomerId = new HashMap<>(headers);
    headersWithoutCustomerId.remove(HTTPRequestHeaderConstants.X_HSBC_Customer_Id);

    lenient().when(customerLimitConfig.getDailyAmount()).thenReturn(BigDecimal.valueOf(1000));
    lenient().when(customerLimitConfig.getMonthlyAmount()).thenReturn(BigDecimal.valueOf(5000));
    lenient().when(customerLimitConfig.getYearlyAmount()).thenReturn(BigDecimal.valueOf(10000));
    lenient().when(customerLimitConfig.getMonthlyCount()).thenReturn(10);

    // 模拟查询返回空结构（因为 customerId 为空，服务返回空）
    LimitEnquiryResponse limitEnquiryResponse = mock(LimitEnquiryResponse.class);
    lenient().when(limitEnquiryResponse.getCbHkHbapObsShrdClcTranLmtEnqWpbSrvOperationResponse()).thenReturn(null);
    lenient().when(restClientService.get(anyString(), anyMap(), eq(LimitEnquiryResponse.class), anyInt(), anyBoolean()))
            .thenReturn(limitEnquiryResponse);

    // 模拟交易金额查询
    RetrieveTransferAmountResponse transferAmountResponse = new RetrieveTransferAmountResponse();
    RetrieveTransferAmountResponseData data = new RetrieveTransferAmountResponseData();
    data.setMonthlyTransferCount(0);
    data.setMonthlyTransferAmount(BigDecimal.ZERO);
    data.setYearlyTransferAmount(BigDecimal.ZERO);
    transferAmountResponse.setData(data);

    lenient().when(restClientService.get(contains("/trade-amount"), anyMap(), eq(RetrieveTransferAmountResponse.class), anyInt(), anyBoolean()))
            .thenReturn(transferAmountResponse);

    RetrieveTransferLimitResponse response = tradeLimitService.retrieveLimitations(headersWithoutCustomerId);
    assertThat(response.getData().getAvailableTodayAmount()).isEqualTo(BigDecimal.ZERO); // 安全降级
}

@Test
void testRetrieveLimitations_customerLimitConfigDailyAmountIsNull() {
    // 配置中 dailyAmount 为 null
    lenient().when(customerLimitConfig.getDailyAmount()).thenReturn(null);
    lenient().when(customerLimitConfig.getMonthlyAmount()).thenReturn(BigDecimal.valueOf(5000));
    lenient().when(customerLimitConfig.getYearlyAmount()).thenReturn(BigDecimal.valueOf(10000));
    lenient().when(customerLimitConfig.getMonthlyCount()).thenReturn(10);

    // 模拟返回一个有效的限额响应
    LimitEnquiryResponse limitEnquiryResponse = mock(LimitEnquiryResponse.class);
    LimitEnquiryResponsePayload payload = new LimitEnquiryResponsePayload();
    LimitEnquiryResponseWork work = new LimitEnquiryResponseWork();
    LimitEnquiryResponseDataWrapper responseWorkRecord = new LimitEnquiryResponseDataWrapper();

    List<TransactionLimitDetailList> details = new ArrayList<>();
    TransactionLimitDetailList detail = new TransactionLimitDetailList();
    detail.setLimitType("P2PS");
    detail.setCurrentLimitAmount(new CurrentLimitAmount());
    detail.getCurrentLimitAmount().setCurrentLimitAmountValue(1000);
    detail.getCurrentLimitAmount().setCurrentLimitAmountDecimal(2);
    detail.setUtilizedLimitAmount(new UtilizedLimitAmount());
    detail.getUtilizedLimitAmount().setUtilizedLimitAmountValue(100);
    detail.getUtilizedLimitAmount().setUtilizedLimitAmountDecimal(2);
    details.add(detail);

    responseWorkRecord.setTransactionLimitDetail(details);
    work.setResponseWorkRecord(responseWorkRecord);
    payload.setResponseWork(work);
    limitEnquiryResponseDataWrapper.setResponsePayload(payload);
    lenient().when(limitEnquiryResponse.getCbHkHbapObsShrdClcTranLmtEnqWpbSrvOperationResponse()).thenReturn(limitEnquiryResponseDataWrapper);

    lenient().when(restClientService.get(anyString(), anyMap(), eq(LimitEnquiryResponse.class), anyInt(), anyBoolean()))
            .thenReturn(limitEnquiryResponse);

    // 模拟交易金额查询
    RetrieveTransferAmountResponse transferAmountResponse = new RetrieveTransferAmountResponse();
    RetrieveTransferAmountResponseData data = new RetrieveTransferAmountResponseData();
    data.setMonthlyTransferCount(0);
    data.setMonthlyTransferAmount(BigDecimal.ZERO);
    data.setYearlyTransferAmount(BigDecimal.ZERO);
    transferAmountResponse.setData(data);

    lenient().when(restClientService.get(contains("/trade-amount"), anyMap(), eq(RetrieveTransferAmountResponse.class), anyInt(), anyBoolean()))
            .thenReturn(transferAmountResponse);

    RetrieveTransferLimitResponse response = tradeLimitService.retrieveLimitations(headers);
    assertThat(response.getData().getMaxDailyLimitedAmount()).isNull(); // 来自 config
    assertThat(response.getData().getAvailableTodayAmount()).isEqualTo(BigDecimal.valueOf(900)); // 1000 - 100
}

@Test
void testRetrieveLimitations_customerLimitConfigMonthlyCountIsNull() {
    // 配置中 monthlyCount 为 null
    lenient().when(customerLimitConfig.getDailyAmount()).thenReturn(BigDecimal.valueOf(1000));
    lenient().when(customerLimitConfig.getMonthlyAmount()).thenReturn(BigDecimal.valueOf(5000));
    lenient().when(customerLimitConfig.getYearlyAmount()).thenReturn(BigDecimal.valueOf(10000));
    lenient().when(customerLimitConfig.getMonthlyCount()).thenReturn(null);

    LimitEnquiryResponse limitEnquiryResponse = mock(LimitEnquiryResponse.class);
    LimitEnquiryResponsePayload payload = new LimitEnquiryResponsePayload();
    LimitEnquiryResponseWork work = new LimitEnquiryResponseWork();
    LimitEnquiryResponseDataWrapper responseWorkRecord = new LimitEnquiryResponseDataWrapper();

    List<TransactionLimitDetailList> details = new ArrayList<>();
    TransactionLimitDetailList detail = new TransactionLimitDetailList();
    detail.setLimitType("P2PS");
    detail.setCurrentLimitAmount(new CurrentLimitAmount());
    detail.getCurrentLimitAmount().setCurrentLimitAmountValue(1000);
    detail.getCurrentLimitAmount().setCurrentLimitAmountDecimal(2);
    detail.setUtilizedLimitAmount(new UtilizedLimitAmount());
    detail.getUtilizedLimitAmount().setUtilizedLimitAmountValue(100);
    detail.getUtilizedLimitAmount().setUtilizedLimitAmountDecimal(2);
    details.add(detail);

    responseWorkRecord.setTransactionLimitDetail(details);
    work.setResponseWorkRecord(responseWorkRecord);
    payload.setResponseWork(work);
    limitEnquiryResponseDataWrapper.setResponsePayload(payload);
    lenient().when(limitEnquiryResponse.getCbHkHbapObsShrdClcTranLmtEnqWpbSrvOperationResponse()).thenReturn(limitEnquiryResponseDataWrapper);

    lenient().when(restClientService.get(anyString(), anyMap(), eq(LimitEnquiryResponse.class), anyInt(), anyBoolean()))
            .thenReturn(limitEnquiryResponse);

    RetrieveTransferAmountResponse transferAmountResponse = new RetrieveTransferAmountResponse();
    RetrieveTransferAmountResponseData data = new RetrieveTransferAmountResponseData();
    data.setMonthlyTransferCount(10); // 超过 null 的“上限”
    data.setMonthlyTransferAmount(BigDecimal.ZERO);
    data.setYearlyTransferAmount(BigDecimal.ZERO);
    transferAmountResponse.setData(data);

    lenient().when(restClientService.get(contains("/trade-amount"), anyMap(), eq(RetrieveTransferAmountResponse.class), anyInt(), anyBoolean()))
            .thenReturn(transferAmountResponse);

    RetrieveTransferLimitResponse response = tradeLimitService.retrieveLimitations(headers);
    assertThat(response.getData().getMaxMonthlyTransferCount()).isNull();
    assertThat(response.getData().getAvailableMonthlyTransferCount()).isEqualTo("-1"); // 因为 null - 10 = -10，但代码中是 String.valueOf(clcMaxMonthCount - used) → String.valueOf(null - 10) 会报错！
    // ❗ 但注意：如果 customerLimitConfig.getMonthlyCount() 返回 null，那么在 initializeResponseData 中会抛 NPE！
    // 我们需要确保代码能优雅处理，或者测试它抛出 NPE（合理）
    // 但当前代码在 initializeResponseData 中直接调用 .getMonthlyCount()，未判空 → 会抛 NPE
    // 所以我们期望它抛 NullPointerException
    assertThrows(NullPointerException.class, () -> tradeLimitService.retrieveLimitations(headers));
}
