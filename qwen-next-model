@Test
public void retrieveTransferList_Success() {
    // --- 1. 准备模拟的请求头 ---
    Map<String, String> requestHeader = new HashMap<>();
    requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID, "C123456");

    // --- 2. 模拟 retrieveCustomerAccounts() 返回有效数据（关键1）---
    CustomerAccounts customerAccounts = new CustomerAccounts();
    List<InvestmentAccount> investmentAccountList = new ArrayList<>();

    InvestmentAccount account = new InvestmentAccount();
    com.hsbc.trade.transfer.domain.account.AccountId accountId = new com.hsbc.trade.transfer.domain.account.AccountId();
    accountId.setCountryAccountCode("HK");
    accountId.setGroupMemberAccountCode("G001");
    accountId.setAccountNumber("123456789");
    accountId.setAccountProductTypeCode("INV");
    accountId.setAccountTypeCode("GOLD");
    accountId.setAccountCurrencyCode("HKD");
    account.setInvestmentAccountId(accountId);
    account.setChecksum("CHK123456"); // 必须有，用于构建 accountIdMap
    investmentAccountList.add(account);

    customerAccounts.setInvestmentAccountList(investmentAccountList);

    when(restClientService.get(
            anyString(), // accountsMapUrl
            anyMap(),    // requestHeaders
            eq(CustomerAccounts.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(customerAccounts);

    // --- 3. 模拟 retrieveCustomerNamesWithCinNumber() 返回 PartyNameResponse ---
    PartyNameResponse partyNameResponse = new PartyNameResponse();
    PartyName name = new PartyName();
    name.setLastName("CHAN");
    name.setGivenName("TOM");
    name.setCustomerChristianName("KING");
    partyNameResponse.setName(name);
    when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
            .thenReturn(partyNameResponse);

    // --- 4. 模拟 retrieveCustomerPhoneNumberWithCinNumber() 返回 PartyContactResponse ---
    PartyContactResponse partyContactResponse = new PartyContactResponse();
    PartyContact contact = new PartyContact();
    contact.setMobileNumber1("12345678");
    partyContactResponse.setContact(contact);
    when(restClientService.get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean()))
            .thenReturn(partyContactResponse);

    // --- 5. ✅ 关键修复：模拟 retrieveTransferLimit() 返回正确的 RetrieveTransferLimitResponseData ---
    RetrieveTransferLimitResponseData limitData = new RetrieveTransferLimitResponseData(); // ✅ 使用正确的类
    limitData.setMaxDailyLimitedAmount(BigDecimal.valueOf(10000));
    limitData.setAvailableTodayAmount(BigDecimal.valueOf(5000));
    limitData.setMaxMonthlyLimitedAmount(BigDecimal.valueOf(50000));
    limitData.setAvailableMonthToDateAmount(BigDecimal.valueOf(25000));
    limitData.setMaxYearlyLimitedAmount(BigDecimal.valueOf(100000));
    limitData.setAvailableYearToDateAmount(BigDecimal.valueOf(75000));

    RetrieveTransferLimitResponse limitResponse = new RetrieveTransferLimitResponse();
    limitResponse.setData(limitData); // ✅ 设置正确的 data 字段

    when(tradeLimitService.retrieveLimitations(anyMap())).thenReturn(limitResponse);

    // --- 6. 模拟 retrieveGoldPrice() ---
    GoldPriceResponse goldPriceResponse = new GoldPriceResponse();
    GoldPriceResponseData goldPriceData = new GoldPriceResponseData();
    goldPriceData.setGoldPriceAmount(BigDecimal.valueOf(100.50));
    goldPriceData.setPublishTime("2025-11-22T10:00:00Z");
    goldPriceResponse.setData(goldPriceData);
    when(restClientService.get(anyString(), anyMap(), eq(GoldPriceResponse.class), anyInt(), anyBoolean()))
            .thenReturn(goldPriceResponse);

    // --- 7. 模拟 E2E Trust Token ---
    when(e2ETrustTokenUtil.getE2ETrustToken()).thenReturn("mock-e2e-token");

    // --- 8. ✅ 关键：模拟最终的 restClientService.get() 调用，返回结构完整的 RetrieveTransferListResponse ---
    // 构造一个完全合法的 RetrieveTransferListResponse 对象
    RetrieveTransferListResponse mockResponse = new RetrieveTransferListResponse();

    // 构造 data 对象
    RetrieveTransferListResponseData data = new RetrieveTransferListResponseData();

    // 构造 responseDetails（ResponseInfoHandler.prepareResponse 会用到）
    ResponseDetails responseDetails = new ResponseDetails();
    responseDetails.setResponseCodeNumber(0); // 成功状态码
    data.setResponseDetails(responseDetails);

    // 构造 transferLists（即使为空，也必须初始化）
    List<TransferListItemInfo> transferLists = new ArrayList<>();
    TransferListItemInfo item = new TransferListItemInfo();
    item.setTransferReferenceNumber("TRF123456789");
    item.setTransferSideCode("SENDER");
    item.setSenderCustomerFirstName("TOM");
    item.setSenderCustomerMiddleName("KING");
    item.setSenderCustomerLastName("CHAN");
    item.setReceiverCustomerFirstName("JACK");
    item.setReceiverCustomerMiddleName("JAMES");
    item.setReceiverCustomerLastName("WONG");
    item.setTransferQuantity(BigDecimal.valueOf(100));
    item.setTransferAmount(BigDecimal.valueOf(10000));
    item.setRequestPriceValue(BigDecimal.valueOf(100.50));
    item.setRequestPriceCurrencyCode("HKD");
    item.setTransferStatus("PENDING");
    item.setTransferDate("2025-11-22");
    item.setSenderInvestmentAccountChecksumIdentifier("CHK123456");
    item.setReceiverInvestmentAccountChecksumIdentifier("CHK987654");
    transferLists.add(item);

    data.setTransferLists(transferLists);

    // 设置 data 到 response
    mockResponse.setData(data);

    // ✅ 现在 mockResponse 是一个完全合法、可被 ResponseInfoHandler 和 maskNamesInResponse 安全处理的对象

    when(restClientService.get(
            anyString(), // 任意URI
            anyMap(),    // 任意请求头
            eq(RetrieveTransferListResponse.class), // 类型必须匹配！
            anyInt(),    // timeout
            anyBoolean() // printMessageLog
    )).thenReturn(mockResponse);

    // --- 9. 调用被测方法 ---
    RetrieveTransferListResponse response = tradeTransferService.retrieveTransferList(
            requestHeader,
            "PENDING",
            Collections.emptyList(),
            "{}",
            "GOLD",
            "MOBILE"
    );

    // --- 10. 断言 ---
    assertNotNull(response);
    assertNotNull(response.getData());
    assertNotNull(response.getData().getTransferLists());
    assertEquals(1, response.getData().getTransferLists().size()); // 确保我们返回了数据
    assertEquals(0, response.getData().getResponseDetails().getResponseCodeNumber()); // 验证响应成功

    // 验证 checksumIdentifiers 被正确添加到请求中（来自 accountIdMap）
    verify(restClientService).get(
            argThat(uri -> uri.contains("checksumIdentifiers=CHK123456")),
            anyMap(),
            eq(RetrieveTransferListResponse.class),
            anyInt(),
            anyBoolean()
    );

    // 验证所有依赖都被调用
    verify(restClientService).get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean());
    verify(restClientService).get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean());
    verify(restClientService).get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean());
    verify(tradeLimitService).retrieveLimitations(anyMap());
    verify(restClientService).get(anyString(), anyMap(), eq(GoldPriceResponse.class), anyInt(), anyBoolean());
    verify(restClientService).get(anyString(), anyMap(), eq(RetrieveTransferListResponse.class), anyInt(), anyBoolean());
}
