@Test
void retrieveTransferDetail_Success_WithCustomerName() {
    // Arrange
    String transferReferenceNumber = "ref123";
    String customerInternalNumber = "testCIN123"; // Extracted from baseRequestHeaders

    // 1. Mock: retrieveTransferDetail Response
    RetrieveTransferDetailResponse mockResponse = new RetrieveTransferDetailResponse();
    RetrieveTransferDetailResponseData responseData = new RetrieveTransferDetailResponseData();
    responseData.setInvestmentAccount(new AccountId()); // Ensure investmentAccount is not null for later processing
    mockResponse.setData(responseData);

    // 2. Mock: CustomerAccounts for extractAccountIdMap (must be valid to pass the check)
    CustomerAccounts mockCustomerAccounts = new CustomerAccounts();
    List<InvestmentAccount> accList = new ArrayList<>();
    InvestmentAccount acc1 = new InvestmentAccount();
    acc1.setChecksum("chk123");
    com.hsbc.trade.transfer.domain.account.AccountId accountId = com.hsbc.trade.transfer.domain.account.AccountId.builder()
            .countryAccountCode("CN")
            .groupMemberAccountCode("G001")
            .accountNumber("123456789012345678901234567890")
            .accountProductTypeCode("01")
            .accountTypeCode("INV")
            .accountCurrencyCode("CNY")
            .build();
    acc1.setInvestmentAccountId(accountId);
    accList.add(acc1);
    mockCustomerAccounts.setInvestmentAccountList(accList); // Now the list is not empty and contains valid objects

    // 3. Mock: PartyNameResponse for addCustomerNameToUri (getName() != null path)
    PartyNameResponse mockPartyNameResponse = new PartyNameResponse();
    PartyName mockName = new PartyName(); // Assuming PartyName class is available
    mockName.setLastName("Doe");
    mockName.setGivenName("John");
    mockName.setCustomerChristianName("Smith");
    mockPartyNameResponse.setName(mockName); // getName() will return this non-null object

    // 4. Mock: PartyContactResponse for addCustomerContactToUri (getContact() != null path)
    PartyContactResponse mockPartyContactResponse = new PartyContactResponse();
    PartyContact mockContact = new PartyContact(); // Assuming PartyContact class is available
    mockContact.setMobileNumber1("12345678");
    mockPartyContactResponse.setContact(mockContact); // getContact() will return this non-null object

    // --- CRITICAL: Mock the specific restClientService.get calls with exact URLs and headers ---
    // 1. Call for retrieveTransferDetail itself
    when(mockRestClientService.get(
            eq(MOCK_TRADE_ONLINE_URL + "/transfers/{transferReferenceNumber}?customerInternalNumber=" + customerInternalNumber + "&sParameterType=SENS"),
            anyMap(), // request headers rebuilt
            eq(RetrieveTransferDetailResponse.class),
            anyInt(), // timeout
            anyBoolean() // printMessageLog
    )).thenReturn(mockResponse);

    // 2. Call for retrieveCustomerAccounts (inside retrieveTransferDetail)
    when(mockRestClientService.get(
            eq(MOCK_ACCOUNTS_MAP_URL + "accounts-map?consumerId=DAC"), // Built URI string
            anyMap(), // request headers rebuilt
            eq(CustomerAccounts.class),
            anyInt(), // timeout
            anyBoolean() // printMessageLog
    )).thenReturn(mockCustomerAccounts);

    // 3. Call for retrieveCustomerNamesWithCinNumber (inside addCustomerNameToUri)
    // 这里是关键：模拟 updateHeaderforCEP 和 buildSensitiveHeaders 后的最终调用
    // 1) buildSensitiveHeaders 会创建一个包含 "SensitiveHeadersKey" 和 "testCIN123" 的 JSON 字符串
    // 2) 然后 Base64 编码后，设置到 X-HSBC-Sensitive-Data 头中
    // 3) 最终的 URL 是 MOCK_CEP_PARTY_NAME_URL 中的 "CIN-SensitiveHeadersKey" 被替换为 "testCIN123"

    // 构建 buildSensitiveHeaders 生成的敏感数据
    String sensitiveDataJson = "[{\"key\":\"SensitiveHeadersKey\",\"value\":\"" + customerInternalNumber + "\"}]";
    String base64SensitiveData = Base64.getEncoder().encodeToString(sensitiveDataJson.getBytes(StandardCharsets.UTF_8));

    // 构建 updateHeaderforCEP 后的 header
    Map<String, String> expectedHeadersForCEP = new HashMap<>();
    expectedHeadersForCEP.putAll(baseRequestHeaders);
    expectedHeadersForCEP.remove(HTTPRequestHeaderConstants.X_HSBC_SAML);
    expectedHeadersForCEP.remove(HTTPRequestHeaderConstants.X_HSBC_SAML3);
    expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_E2E_TRUST_TOKEN, "e2e-token"); // 从 setUp() 中的 mock
    expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_GBGF, ""); // 从 @Value 注入的默认值
    expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_SOURCE_SYSTEM_ID, ""); // 从 @Value 注入的默认值
    expectedHeadersForCEP.put(HTTPRequestHeaderConstants.X_HSBC_SENSITIVE_DATA, base64SensitiveData); // 关键！模拟 buildSensitiveHeaders 的输出

    // 构建最终的 URL
    String expectedNameUrl = MOCK_CEP_PARTY_NAME_URL.replace("CIN-SensitiveHeadersKey", customerInternalNumber);

    // 模拟 restClientService.get 对 CEP 名称服务的调用
    when(mockRestClientService.get(
            eq(expectedNameUrl), // URL 必须匹配
            argThat(headers -> headers.equals(expectedHeadersForCEP)), // Header 必须完全匹配
            eq(PartyNameResponse.class),
            anyInt(), // timeout
            anyBoolean() // printMessageLog
    )).thenReturn(mockPartyNameResponse);

    // 4. Call for retrieveCustomerPhoneNumberWithCinNumber (inside addCustomerContactToUri)
    // 与上面同理，但注意：addCustomerContactToUri 也调用了 updateHeaderforCEP，所以 header 与上面完全相同！
    String expectedContactUrl = MOCK_CEP_PARTY_CONTACT_URL.replace("CIN-SensitiveHeadersKey", customerInternalNumber);

    when(mockRestClientService.get(
            eq(expectedContactUrl),
            argThat(headers -> headers.equals(expectedHeadersForCEP)), // 与上面完全相同的 header
            eq(PartyContactResponse.class),
            anyInt(), // timeout
            anyBoolean() // printMessageLog
    )).thenReturn(mockPartyContactResponse);

    // Mock E2E token generation for updateHeaderforCEP calls
    when(mockE2ETrustTokenUtil.getE2ETrustToken()).thenReturn("e2e-token");

    // Act
    RetrieveTransferDetailResponse result = tradeTransferService.retrieveTransferDetail(baseRequestHeaders, transferReferenceNumber);

    // Assert
    assertNotNull(result);
    // Verify the specific interactions happened
    verify(mockRestClientService, times(1)).get(
            eq(MOCK_TRADE_ONLINE_URL + "/transfers/{transferReferenceNumber}?customerInternalNumber=" + customerInternalNumber + "&sParameterType=SENS"),
            anyMap(),
            eq(RetrieveTransferDetailResponse.class),
            anyInt(),
            anyBoolean()
    );
    verify(mockRestClientService, times(1)).get(
            eq(MOCK_ACCOUNTS_MAP_URL + "accounts-map?consumerId=DAC"),
            anyMap(),
            eq(CustomerAccounts.class),
            anyInt(),
            anyBoolean()
    );
    verify(mockRestClientService, times(1)).get(
            eq(expectedNameUrl),
            argThat(headers -> headers.equals(expectedHeadersForCEP)),
            eq(PartyNameResponse.class),
            anyInt(),
            anyBoolean()
    );
    verify(mockRestClientService, times(1)).get(
            eq(expectedContactUrl),
            argThat(headers -> headers.equals(expectedHeadersForCEP)),
            eq(PartyContactResponse.class),
            anyInt(),
            anyBoolean()
    );
    // 验证 E2E token 被获取了两次（一次用于 name，一次用于 contact）
    verify(mockE2ETrustTokenUtil, times(2)).getE2ETrustToken();
}
