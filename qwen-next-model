@Test
void createTransfers_Success() {
    // Arrange
    CreateTransferRequest request = new CreateTransferRequest();
    CreateTransferRequestData data = new CreateTransferRequestData();
    request.setData(data);
    // Set sender checksum
    request.getData().setSenderInvestmentAccountChecksumIdentifier("CHECKSUM123");
    request.getData().setActionRequestCode(ActionRequestCode.D);

    // Create receiver list
    List<ReceiverInfo> receivers = new ArrayList<>();
    ReceiverInfo receiver = new ReceiverInfo();
    receiver.setTransferQuantity(new BigDecimal("10.5"));
    receiver.setReceiverCustomerNumber("RECEIVER123");
    receivers.add(receiver);
    request.getData().setReceiverLists(receivers);

    // --- Mock 1: Simulate the remote call inside retrieveAccountIdWithCheckSum ---
    // This is the call to customerAccountUrl
    RetrieveCustomerAccountsIdListResponse accountIdListResponse = new RetrieveCustomerAccountsIdListResponse();
    InvestmentAccountId accountId = new InvestmentAccountId();
    accountId.setCountryAccountCode("HK");
    accountId.setGroupMemberAccountCode("HBAP");
    accountId.setAccountNumber("123456789");
    accountId.setAccountProductTypeCode("SAV");
    accountId.setAccountTypeCode("01");
    accountId.setAccountCurrencyCode("HKD");

    InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
    accountIdList.setAccountId(accountId);
    accountIdListResponse.setAccountIdList(Collections.singletonList(accountIdList));

    // Build the expected URL for the customerAccountUrl call
    String bodyJson = "{\"checksumList\":[\"CHECKSUM123\"]}";
    String encodedBody = URLEncoder.encode(bodyJson, StandardCharsets.UTF_8);
    String expectedAccountIdUrl = MOCK_CUSTOMER_ACCOUNT_URL + "/accounts/ids?checksumList=" + encodedBody;

    // Build the expected headers for the customerAccountUrl call
    Map<String, String> expectedHeadersForAccountIdRetrieval = new HashMap<>();
    expectedHeadersForAccountIdRetrieval.putAll(sourceRequestHeader);
    expectedHeadersForAccountIdRetrieval.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID, sourceRequestHeader.get(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID));
    expectedHeadersForAccountIdRetrieval.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID_TYPE, "N");
    expectedHeadersForAccountIdRetrieval.put(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE);
    expectedHeadersForAccountIdRetrieval.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
    expectedHeadersForAccountIdRetrieval.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);
    expectedHeadersForAccountIdRetrieval.put(HTTPRequestHeaderConstants.X_HSBC_SOURCE_INSTRUCTION_CODE, TransferQueryParameterConstant.RBP_SOURCE_INSTRUCTION_CODE_MOB);

    // Mock the specific restClientService.get call for the account ID retrieval (using the injected restClientService)
    when(restClientService.get(
            eq(expectedAccountIdUrl),
            argThat(headers -> headers.equals(expectedHeadersForAccountIdRetrieval)),
            eq(RetrieveCustomerAccountsIdListResponse.class),
            eq(10000),
            eq(true)
    )).thenReturn(accountIdListResponse);

    // --- Mock 2: Simulate the remote call inside sreValidationService.callSreForTransferValidation ---
    // This is the CRITICAL missing piece for validateSreForReceivers
    // We need to set the restClientService of the injected sreValidationService to our mock
    ReflectionTestUtils.setField(sreValidationService, "restClientService", mockRestClientService); // <-- KEY FIX
    // Also set the E2ETrustTokenUtil and sreUrl for the injected sreValidationService
    ReflectionTestUtils.setField(sreValidationService, "e2ETrustTokenUtil", mockE2ETrustTokenUtil);
    ReflectionTestUtils.setField(sreValidationService, "sreUrl", TEST_SRE_URL);

    // Now mock the specific POST call that sreValidationService will make
    // The rule for sender is "dac_tokenized_gold_transfer_sender_rule"
    String expectedSreUrl = TEST_SRE_URL;
    // Build the expected SRE request body (this is what SreValidationServiceImpl builds)
    SreRequest expectedSreRequest = new SreRequest();
    expectedSreRequest.setRuleName("dac_tokenized_gold_transfer_sender_rule");
    expectedSreRequest.setSenderId("CUST123"); // This comes from sourceRequestHeader
    expectedSreRequest.setReceiverId("RECEIVER123"); // This comes from receiver.getReceiverCustomerNumber()
    expectedSreRequest.setAdditionalInfo(new HashMap<>()); // Can be empty

    // Create the mock SRE response
    RuleResponse mockSreResponse = new RuleResponse();
    RuleResponseDTO mockResult = new RuleResponseDTO();
    mockResult.setReasonCodes(Collections.emptyList());
    mockSreResponse.setResults(mockResult);

    // Mock the specific restClientService.post call inside sreValidationService
    when(mockRestClientService.post(
            eq(expectedSreUrl),
            anyMap(), // Headers will be built by sreValidationService, we can use anyMap() for simplicity
            eq(expectedSreRequest), // Match the exact SreRequest object we expect
            eq(RuleResponse.class),
            anyInt(),
            anyBoolean()
    )).thenReturn(mockSreResponse);

    // Mock E2E token generation for updateHeaderforCEP (used in validateSreForReceivers)
    when(mockE2ETrustTokenUtil.getE2ETrustToken()).thenReturn("e2e-token");

    // --- Mock 3: Simulate the retrieveGoldPrice call (for ActionRequestCode.D) ---
    GoldPriceResponse goldPriceResponse = createMockGoldPriceResponse();
    when(restClientService.get(anyString(), anyMap(), eq(GoldPriceResponse.class), anyInt(), anyBoolean()))
            .thenReturn(goldPriceResponse);

    // --- Mock 4: Simulate the retrieveCustomerNamesWithCinNumber call (for setSenderNames) ---
    PartyNameResponse partyNameResponse = createMockPartyNameResponse();
    when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
            .thenReturn(partyNameResponse);

    // --- Mock 5: Simulate the final create transfer POST call ---
    CreateTransferResponse mockResponse = new CreateTransferResponse();
    ResponseDetails responseDetails = new ResponseDetails();
    responseDetails.setResponseCodeNumber(0);
    mockResponse.setResponseDetails(responseDetails);
    when(restClientService.post(anyString(), anyMap(), any(CreateTransferRequest.class),
            eq(CreateTransferResponse.class), anyInt(), anyBoolean())).thenReturn(mockResponse);

    // --- Mock 6: Simulate the tradeLimitService.retrieveLimitations call ---
    RetrieveTransferLimitResponse limitResponse = createMockTransferLimitResponse();
    // Ensure the limits are high enough to avoid TransferLimitExceededException
    limitResponse.getData().setAvailableTodayAmount(new BigDecimal("100000")); // > 10.5 * price
    limitResponse.getData().setAvailableMonthToDateAmount(new BigDecimal("100000"));
    limitResponse.getData().setAvailableYearToDateAmount(new BigDecimal("100000"));
    when(tradeLimitService.retrieveLimitations(anyMap())).thenReturn(limitResponse);

    // Act
    CreateTransferResponse result = tradeTransferService.createTransfers(sourceRequestHeader, request);

    // Assert
    assertNotNull(result);
    assertEquals(0, result.getResponseDetails().getResponseCodeNumber());

    // Verify all dependencies were called as expected
    verify(tradeLimitService, times(1)).retrieveLimitations(anyMap());
    verify(restClientService, times(1)).get(
            eq(expectedAccountIdUrl),
            argThat(headers -> headers.equals(expectedHeadersForAccountIdRetrieval)),
            eq(RetrieveCustomerAccountsIdListResponse.class),
            eq(10000),
            eq(true)
    );
    verify(restClientService, times(1)).get(anyString(), anyMap(), eq(GoldPriceResponse.class), anyInt(), anyBoolean());
    verify(restClientService, times(1)).get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean());
    verify(restClientService, times(1)).post(anyString(), anyMap(), any(CreateTransferRequest.class),
            eq(CreateTransferResponse.class), anyInt(), anyBoolean());
    verify(mockRestClientService, times(1)).post(
            eq(expectedSreUrl),
            anyMap(),
            eq(expectedSreRequest),
            eq(RuleResponse.class),
            anyInt(),
            anyBoolean()
    );
    verify(mockE2ETrustTokenUtil, times(2)).getE2ETrustToken(); // Once for SRE, once for CEP
}
