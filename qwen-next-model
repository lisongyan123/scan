import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpStatus;
import org.springframework.web.client.HttpClientErrorException;

import java.math.BigDecimal;
import java.util.*;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

@ExtendWith(MockitoExtension.class)
public class TradeTransferServiceImplTest {

    @Mock
    private RestClientService restClientService;

    @Mock
    private E2ETrustTokenUtil e2ETrustTokenUtil;

    @Mock
    private DuplicateSubmitPreventionService duplicateSubmitPreventionService;

    @Mock
    private TradeLimitServiceImpl tradeLimitService;

    @Mock
    private SreValidationServiceImpl sreValidationService;

    @InjectMocks
    private TradeTransferServiceImpl tradeTransferService; // 被测类

    // =============== 测试 retrieveTransferList() ===============

    @Test
    public void retrieveTransferList_Success() {
        // --- 1. 准备模拟的请求头 ---
        Map<String, String> requestHeader = new HashMap<>();
        requestHeader.put("X-HSBC-Customer-ID", "C123456");

        // --- 2. 模拟 retrieveCustomerAccounts() 的返回值（关键！）---
        CustomerAccounts customerAccounts = new CustomerAccounts();
        List<InvestmentAccount> investmentAccountList = new ArrayList<>();

        // 创建一个有效的投资账户，包含 checksum 和 accountId
        InvestmentAccount account = new InvestmentAccount();
        AccountId accountId = new AccountId();
        accountId.setCountryAccountCode("HK");
        accountId.setGroupMemberAccountCode("G001");
        accountId.setAccountNumber("123456789");
        accountId.setAccountProductTypeCode("INV");
        accountId.setAccountTypeCode("GOLD");
        accountId.setAccountCurrencyCode("HKD");
        account.setInvestmentAccountId(accountId);
        account.setChecksum("CHK123456"); // 必须有这个字段！
        investmentAccountList.add(account);

        customerAccounts.setInvestmentAccountList(investmentAccountList);

        // 模拟 restClientService.get(...) 调用，返回上面构建的 customerAccounts
        when(restClientService.get(
                anyString(), // accountsMapUrl
                anyMap(),    // requestHeaders
                eq(CustomerAccounts.class),
                anyInt(),
                anyBoolean()
        )).thenReturn(customerAccounts);

        // --- 3. 模拟其他依赖（如 CEP 服务）---
        PartyNameResponse partyNameResponse = new PartyNameResponse();
        PartyNameResponse.Name name = new PartyNameResponse.Name();
        name.setLastName("CHAN");
        name.setGivenName("TOM");
        name.setCustomerChristianName("KING");
        partyNameResponse.setName(name);
        when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
                .thenReturn(partyNameResponse);

        PartyContactResponse partyContactResponse = new PartyContactResponse();
        PartyContactResponse.Contact contact = new PartyContactResponse.Contact();
        contact.setMobileNumber1("12345678");
        partyContactResponse.setContact(contact);
        when(restClientService.get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean()))
                .thenReturn(partyContactResponse);

        // --- 4. 模拟 retrieveTransferLimit() ---
        RetrieveTransferLimitResponse limitResponse = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponse.Data limitData = new RetrieveTransferLimitResponse.Data();
        limitData.setMaxDailyLimitedAmount(BigDecimal.valueOf(10000));
        limitData.setAvailableTodayAmount(BigDecimal.valueOf(5000));
        limitResponse.setData(limitData);
        when(tradeLimitService.retrieveLimitations(anyMap())).thenReturn(limitResponse);

        // --- 5. 模拟 CEP 的 E2E Trust Token 头部（如果需要）---
        when(e2ETrustTokenUtil.getE2ETrustToken()).thenReturn("mock-e2e-token");

        // --- 6. 调用被测方法 ---
        RetrieveTransferListResponse response = tradeTransferService.retrieveTransferList(
                requestHeader,
                "PENDING",
                Collections.emptyList(),
                "{}",
                "GOLD",
                "MOBILE"
        );

        // --- 7. 断言 ---
        assertNotNull(response);
        assertNotNull(response.getData());
        assertNotNull(response.getData().getTransferLists());
        assertTrue(response.getData().getTransferLists().isEmpty()); // 根据您的业务，这里可能为空，但至少请求构建成功

        // 验证 restClientService 被正确调用，且传入了 checksumIdentifiers 参数
        verify(restClientService).get(
                argThat(uri -> uri.contains("checksumIdentifiers=CHK123456")), // 确保 checksum 被传入
                anyMap(),
                eq(RetrieveTransferListResponse.class),
                anyInt(),
                anyBoolean()
        );
    }

    // =============== 测试 retrieveTransferList() - 异常情况（可选） ===============
    // 如果您的测试用例中有“空账户列表”的异常场景，也可以模拟返回空列表
    @Test
    public void retrieveTransferList_AccountListEmpty() {
        // 模拟返回空账户列表
        CustomerAccounts customerAccounts = new CustomerAccounts();
        customerAccounts.setInvestmentAccountList(new ArrayList<>());

        when(restClientService.get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean()))
                .thenReturn(customerAccounts);

        // 其他模拟省略...

        // 调用方法
        RetrieveTransferListResponse response = tradeTransferService.retrieveTransferList(
                Map.of("X-HSBC-Customer-ID", "C123456"),
                "PENDING",
                Collections.emptyList(),
                "{}",
                "GOLD",
                "MOBILE"
        );

        // 由于 extractAccountIdMap() 返回空 Map，不会抛异常，但 uriBuilder 不会添加 checksumIdentifiers
        // 如果您的业务要求必须有账户才能调用，这里可以断言日志或行为
        assertNotNull(response);
        verify(restClientService).get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean());
    }
}
