// ... (保留您已有的 @ExtendWith, @Mock, @InjectMocks, @BeforeEach 和 retrieveTransferList(), createTransfer(), modifyTransfer() 测试)

    /**
     * 测试 retrieveTransferList 方法在客户账户为空时的行为。
     * 验证是否跳过了 CHECKSUM_IDENTIFIERS 参数和敏感头的构建。
     */
    @Test
    void retrieveTransferList_whenCustomerAccountsEmpty_doesNotAddAccountParams() {
        // Arrange
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        RetrieveTransferListResponse response = new RetrieveTransferListResponse();
        RetrieveTransferListResponseData responseData = new RetrieveTransferListResponseData();
        responseData.setTransferLists(new ArrayList<>());
        response.setData(responseData);
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        response.setResponseDetails(responseDetails);

        // Mock: 返回空的客户账户列表
        CustomerAccounts emptyAccounts = new CustomerAccounts();
        emptyAccounts.setInvestmentAccountList(Collections.emptyList());

        when(restClientService.get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean()))
                .thenReturn(emptyAccounts);
        when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
                .thenReturn(new PartyNameResponse()); // 简化
        when(restClientService.get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean()))
                .thenReturn(new PartyContactResponse()); // 简化
        when(restClientService.get(argThat(uri -> uri.contains("transfers")), anyMap(), eq(RetrieveTransferListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(response);

        // Act
        RetrieveTransferListResponse result = tradeTransferService.retrieveTransferList(
                sourceRequestHeader, "ALL", null, "{}", "", "PLAIN_TEXT");

        // Assert
        assertThat(result).isNotNull();

        // Verify: 确保没有调用构建敏感信息的方法（该方法会使用restClientService.post）
        verify(restClientService, never()).post(anyString(), anyMap(), any(), any(Class.class), anyInt(), anyBoolean());
    }

    /**
     * 测试 retrieveTransferDetail 方法在响应数据为空或投资账户为空时，能正常返回而不抛出异常。
     */
    @Test
    void retrieveTransferDetail_whenResponseDataIsNull_returnsResponseAsIs() {
        // Arrange
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID, CUSTOMER_INTERNAL_NUMBER);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);

        RetrieveTransferDetailResponse nullDataResponse = new RetrieveTransferDetailResponse();
        nullDataResponse.setData(null); // Data is null

        when(restClientService.get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean()))
                .thenReturn(new CustomerAccounts()); // 空账户
        when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
                .thenReturn(new PartyNameResponse());
        when(restClientService.get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean()))
                .thenReturn(new PartyContactResponse());
        when(restClientService.get(anyString(), anyMap(), eq(RetrieveTransferDetailResponse.class), anyInt(), anyBoolean()))
                .thenReturn(nullDataResponse);

        // Act & Assert
        RetrieveTransferDetailResponse result = tradeTransferService.retrieveTransferDetail(sourceRequestHeader, TRANSFER_REF);
        assertThat(result.getData()).isNull(); // 应保持为null
    }

    /**
     * 测试 retrieveTransferDetail 方法在无法找到账户映射时，抛出正确的 BadRequestException。
     */
    @Test
    void retrieveTransferDetail_whenAccountMappingNotFound_throwsBadRequestException() {
        // Arrange
        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID, CUSTOMER_INTERNAL_NUMBER);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);

        RetrieveTransferDetailResponseData detailData = new RetrieveTransferDetailResponseData();
        InvestmentAccount invAcc = new InvestmentAccount();
        invAcc.setAccountNumber("ACC_MISSING"); // 这个ID在mock的账户列表中找不到
        detailData.setInvestmentAccount(invAcc);
        RetrieveTransferDetailResponse response = new RetrieveTransferDetailResponse();
        response.setData(detailData);

        // Mock: 账户列表中不包含 accountNumber="ACC_MISSING" 的账户
        InvestmentAccount existingAcc = new InvestmentAccount();
        existingAcc.setChecksum("CHK_EXISTING");
        existingAcc.setAccountNumber("ACC_EXISTING");
        CustomerAccounts customerAccounts = new CustomerAccounts();
        customerAccounts.setInvestmentAccountList(Collections.singletonList(existingAcc));

        when(restClientService.get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean()))
                .thenReturn(customerAccounts);
        when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
                .thenReturn(new PartyNameResponse());
        when(restClientService.get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean()))
                .thenReturn(new PartyContactResponse());
        when(restClientService.get(anyString(), anyMap(), eq(RetrieveTransferDetailResponse.class), anyInt(), anyBoolean()))
                .thenReturn(response);

        // Act & Assert
        assertThatThrownBy(() -> tradeTransferService.retrieveTransferDetail(sourceRequestHeader, TRANSFER_REF))
                .isInstanceOf(BadRequestException.class)
                .hasMessageContaining(ACCOUNT_LIST_EMPTY_ERROR.getCode());
    }

    /**
     * 测试 createTransfers 方法在获取黄金价格失败时，能正确记录错误但不中断主流程。
     */
    @Test
    void createTransfers_whenGoldPriceIsNull_logsErrorButContinues() {
        // Arrange
        CreateTransferRequest request = new CreateTransferRequest();
        CreateTransferRequestData data = new CreateTransferRequestData();
        ReceiverInfo receiver = new ReceiverInfo();
        receiver.setTransferQuantity(BigDecimal.TEN);
        data.setReceiverLists(Collections.singletonList(receiver));
        data.setActionRequestCode(ActionRequestCode.D); // 触发金价设置逻辑
        request.setData(data);

        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID, CUSTOMER_INTERNAL_NUMBER);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);

        // Mock: Limit Service (假设通过)
        RetrieveTransferLimitResponse limitResponse = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponseData limitData = new RetrieveTransferLimitResponseData();
        limitData.setAvailableTodayAmount(BigDecimal.valueOf(1000)); // 大于交易额
        limitResponse.setData(limitData);
        when(tradeLimitService.retrieveLimitations(anyMap())).thenReturn(limitResponse);

        // Mock: SRE Validation (假设通过)
        RuleResponse sreResponse = new RuleResponse();
        when(sreValidationService.callSreForTransferValidation(anyString(), anyString(), anyString(), anyMap()))
                .thenReturn(sreResponse);

        // Mock: Name Response (假设成功)
        PartyNameResponse nameResponse = new PartyNameResponse();
        nameResponse.setGivenName("David");
        when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
                .thenReturn(nameResponse);

        // Mock: Gold Price Response 为 null 或 data 为 null
        when(restClientService.get(anyString(), anyMap(), eq(GoldPriceResponse.class), anyInt(), anyBoolean()))
                .thenReturn(null); // 或者一个data为null的GoldPriceResponse

        // Mock: Account ID Mapping
        AccountId mockAccountId = new AccountId();
        when(restClientService.get(anyString(), anyMap(), eq(AccountId.class), anyInt(), anyBoolean()))
                .thenReturn(mockAccountId);

        // Mock: 最终创建转账成功
        CreateTransferResponse successResponse = new CreateTransferResponse();
        successResponse.setData(new CreateTransferResponse.Data());
        when(restClientService.post(anyString(), anyMap(), any(CreateTransferRequest.class), eq(CreateTransferResponse.class), anyInt(), anyBoolean()))
                .thenReturn(successResponse);

        // Act
        CreateTransferResponse result = tradeTransferService.createTransfers(sourceRequestHeader, request);

        // Assert
        assertThat(result).isNotNull();
        // 验证因为金价为null，所以request中的价格没有被覆盖（应保持原样或为null）
        // （如果request中原本有价格，则未被覆盖；如果原本没有，则仍为null）
        // 此处主要验证流程继续执行，没有因金价问题而抛出异常
        verify(restClientService, times(1)).post(anyString(), anyMap(), any(CreateTransferRequest.class), eq(CreateTransferResponse.class), anyInt(), anyBoolean());
    }

    /**
     * 测试 modifyTransfers 方法在 actionCode 不是 A 或 R 时，不执行任何特殊逻辑。
     */
    @Test
    void modifyTransfers_whenActionCodeNotAOrR_skipsSpecialLogic() {
        // Arrange
        UpdateTransferRequest request = new UpdateTransferRequest();
        UpdateTransferRequestData data = new UpdateTransferRequestData();
        data.setTransferActionCode(TransferActionCode.C); // CANCEL, 不是A或R
        request.setData(data);

        Map<String, String> sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID, CUSTOMER_INTERNAL_NUMBER);
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);

        UpdateTransferResponse successResponse = new UpdateTransferResponse();
        when(restClientService.put(anyString(), anyMap(), any(UpdateTransferRequest.class), eq(UpdateTransferResponse.class), anyInt(), anyBoolean()))
                .thenReturn(successResponse);

        // Act
        UpdateTransferResponse result = tradeTransferService.modifyTransfers(sourceRequestHeader, request);

        // Assert
        assertThat(result).isNotNull();
        // Verify: 确保没有调用 retrieveAccountIdWithCheckSum 和 sreValidationService
        verify(restClientService, never()).get(anyString(), anyMap(), eq(AccountId.class), anyInt(), anyBoolean());
        verify(sreValidationService, never()).callSreForTransferValidation(anyString(), anyString(), anyString(), anyMap());
    }

    /**
     * 测试 maskNamesInResponse 方法对列表中不同 transferSideCode 的项进行正确脱敏。
     */
    @Test
    void maskNamesInResponse_masksCorrectFieldsBasedOnTransferSide() throws Exception {
        // Arrange
        RetrieveTransferListResponseData data = new RetrieveTransferListResponseData();
        List<TransferListItemInfo> list = new ArrayList<>();

        TransferListItemInfo item1 = new TransferListItemInfo();
        item1.setTransferSideCode(TransferSideCode.RECEIVER); // 接收方，应脱敏发送方姓名
        item1.setSenderCustomerFirstName("Alice");
        item1.setSenderCustomerMiddleName("Wonder");
        item1.setSenderCustomerLastName("Smith");

        TransferListItemInfo item2 = new TransferListItemInfo();
        item2.setTransferSideCode(TransferSideCode.SENDER); // 发送方，且接收方是银行客户
        item2.setIsReceiverBankCustomer("Y");
        item2.setReceiverCustomerFirstName("Bob");
        item2.setReceiverCustomerMiddleName("Builder");
        item2.setReceiverCustomerLastName("Johnson");

        list.add(item1);
        list.add(item2);
        data.setTransferLists(list);

        // Act
        tradeTransferService.maskNamesInResponse(data); // 注意：这是public方法，可以直接调用

        // Assert
        assertThat(item1.getSenderCustomerFirstName()).isEqualTo("A***"); // A + 4个*
        assertThat(item1.getSenderCustomerMiddleName()).isEqualTo("W****"); // W + 4个*
        assertThat(item1.getSenderCustomerLastName()).isEqualTo("S****"); // S + 4个*

        assertThat(item2.getReceiverCustomerFirstName()).isEqualTo("B**");
        assertThat(item2.getReceiverCustomerMiddleName()).isEqualTo("B*****");
        assertThat(item2.getReceiverCustomerLastName()).isEqualTo("J******");
    }

    /**
     * 测试 validateTransferLimits 方法在超过月限额时抛出 monthly 异常。
     */
    @Test
    void validateTransferLimits_monthlyLimitExceeded_throwsMonthlyException() {
        // Arrange
        BigDecimal totalAmount = new BigDecimal("6000");
        RetrieveTransferLimitResponse currentLimit = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponseData data = new RetrieveTransferLimitResponseData();
        data.setMaxMonthlyLimitedAmount(new BigDecimal("5000"));
        data.setAvailableMonthToDateAmount(new BigDecimal("4000")); // 小于totalAmount
        currentLimit.setData(data);

        // Act & Assert
        assertThatThrownBy(() -> tradeTransferService.validateTransferLimits(totalAmount, currentLimit))
                .isInstanceOf(TransferLimitExceededException.class)
                .hasMessageContaining("monthly")
                .hasMessageContaining("5000");
    }
