@Test
void validateTransferLimits_WhenDailyLimitExceeded_ShouldThrowException() {
    // Arrange
    BigDecimal totalTranAmount = new BigDecimal("1000");
    RetrieveTransferLimitResponse currentLimit = new RetrieveTransferLimitResponse();
    RetrieveTransferLimitResponseData data = new RetrieveTransferLimitResponseData();
    data.setAvailableTodayAmount(new BigDecimal("500")); // Less than total amount
    data.setMaxDailyLimitedAmount(new BigDecimal("1000"));
    currentLimit.setData(data);
    
    // Act & Assert
    assertThrows(TransferLimitExceededException.class, () -> {
        tradeTransferService.validateTransferLimits(totalTranAmount, currentLimit);
    });
}

@Test
void validateTransferLimits_WhenMonthlyLimitExceeded_ShouldThrowException() {
    // Arrange
    BigDecimal totalTranAmount = new BigDecimal("1000");
    RetrieveTransferLimitResponse currentLimit = new RetrieveTransferLimitResponse();
    RetrieveTransferLimitResponseData data = new RetrieveTransferLimitResponseData();
    data.setAvailableMonthToDateAmount(new BigDecimal("500")); // Less than total amount
    data.setMaxMonthlyLimitedAmount(new BigDecimal("1000"));
    currentLimit.setData(data);
    
    // Act & Assert
    assertThrows(TransferLimitExceededException.class, () -> {
        tradeTransferService.validateTransferLimits(totalTranAmount, currentLimit);
    });
}

@Test
void validateTransferLimits_WhenYearlyLimitExceeded_ShouldThrowException() {
    // Arrange
    BigDecimal totalTranAmount = new BigDecimal("1000");
    RetrieveTransferLimitResponse currentLimit = new RetrieveTransferLimitResponse();
    RetrieveTransferLimitResponseData data = new RetrieveTransferLimitResponseData();
    data.setAvailableYearToDateAmount(new BigDecimal("500")); // Less than total amount
    data.setMaxYearlyLimitedAmount(new BigDecimal("1000"));
    currentLimit.setData(data);
    
    // Act & Assert
    assertThrows(TransferLimitExceededException.class, () -> {
        tradeTransferService.validateTransferLimits(totalTranAmount, currentLimit);
    });
}

@Test
void validateTransferLimits_WhenAllLimitsAreSufficient_ShouldNotThrowException() {
    // Arrange
    BigDecimal totalTranAmount = new BigDecimal("500");
    RetrieveTransferLimitResponse currentLimit = new RetrieveTransferLimitResponse();
    RetrieveTransferLimitResponseData data = new RetrieveTransferLimitResponseData();
    data.setAvailableTodayAmount(new BigDecimal("1000"));
    data.setAvailableMonthToDateAmount(new BigDecimal("1000"));
    data.setAvailableYearToDateAmount(new BigDecimal("1000"));
    currentLimit.setData(data);
    
    // Act & Assert
    assertDoesNotThrow(() -> {
        tradeTransferService.validateTransferLimits(totalTranAmount, currentLimit);
    });
}

@Test
void handleDOperationResponse_WhenActionIsD_ShouldSetRequestUniqueKeyAndPrice() {
    // Arrange
    CreateTransferRequest createTransferRequest = new CreateTransferRequest();
    CreateTransferRequestData data = new CreateTransferRequestData();
    data.setActionRequestCode(ActionRequestCode.D); // D operation
    createTransferRequest.setData(data);

    CreateTransferResponse createTransferResponse = new CreateTransferResponse();
    CreateTransferRequestData responseData = new CreateTransferRequestData();
    List<TransferOrderInfo> orderInfoList = new ArrayList<>();
    TransferOrderInfo orderInfo = new TransferOrderInfo();
    orderInfo.setRequestPriceValue(new BigDecimal("100"));
    orderInfoList.add(orderInfo);
    responseData.setTransferOrderLists(orderInfoList);
    createTransferResponse.setData(responseData);

    GoldPriceResponse goldPriceResponse = new GoldPriceResponse();
    GoldPriceResponseData mdsData = new GoldPriceResponseData();
    mdsData.setGoldPriceAmount(new BigDecimal("1000"));
    mdsData.setPublishTime("2025-11-20T10:00:00Z");
    goldPriceResponse.setData(mdsData);

    // Mock the duplicateSubmitPreventionService to return a unique key
    String mockUniqueKey = "unique-key-123";
    when(tradeTransferService.duplicateSubmitPreventionService.generateUniqueKey()).thenReturn(mockUniqueKey);

    // Act
    tradeTransferService.handleDOperationResponse(createTransferRequest, createTransferResponse, goldPriceResponse);

    // Assert
    assertNotNull(createTransferResponse.getData().getRequestUniqueKey());
    assertEquals(mockUniqueKey, createTransferResponse.getData().getRequestUniqueKey());
    assertEquals(new BigDecimal("1000"), createTransferResponse.getData().getTransferOrderLists().get(0).getRequestPriceValue());
    assertEquals("HKD", createTransferResponse.getData().getTransferOrderLists().get(0).getPriceCurrencyCode());
    assertEquals("2025-11-20T10:00:00Z", createTransferResponse.getData().getTransferOrderLists().get(0).getRequestPriceAsOfDateTime());
}

@Test
void handleDOperationResponse_WhenActionIsNotD_ShouldNotModifyResponse() {
    // Arrange
    CreateTransferRequest createTransferRequest = new CreateTransferRequest();
    CreateTransferRequestData data = new CreateTransferRequestData();
    data.setActionRequestCode(ActionRequestCode.C); // Not D operation
    createTransferRequest.setData(data);

    CreateTransferResponse createTransferResponse = new CreateTransferResponse();
    CreateTransferRequestData responseData = new CreateTransferRequestData();
    List<TransferOrderInfo> orderInfoList = new ArrayList<>();
    TransferOrderInfo orderInfo = new TransferOrderInfo();
    orderInfo.setRequestPriceValue(new BigDecimal("100"));
    orderInfoList.add(orderInfo);
    responseData.setTransferOrderLists(orderInfoList);
    createTransferResponse.setData(responseData);

    GoldPriceResponse goldPriceResponse = new GoldPriceResponse();
    GoldPriceResponseData mdsData = new GoldPriceResponseData();
    mdsData.setGoldPriceAmount(new BigDecimal("1000"));
    mdsData.setPublishTime("2025-11-20T10:00:00Z");
    goldPriceResponse.setData(mdsData);

    // Act
    tradeTransferService.handleDOperationResponse(createTransferRequest, createTransferResponse, goldPriceResponse);

    // Assert
    assertNull(createTransferResponse.getData().getRequestUniqueKey()); // Should not be set
    assertEquals(new BigDecimal("100"), createTransferResponse.getData().getTransferOrderLists().get(0).getRequestPriceValue()); // Should remain unchanged
    assertEquals("HKD", createTransferResponse.getData().getTransferOrderLists().get(0).getPriceCurrencyCode()); // Should remain unchanged
    assertEquals("2025-11-20T10:00:00Z", createTransferResponse.getData().getTransferOrderLists().get(0).getRequestPriceAsOfDateTime()); // Should remain unchanged
}

@Test
void findAccountChecksumForAccountNumber_WhenAccountExists_ShouldReturnChecksum() {
    // Arrange
    CustomerAccounts customerAccounts = new CustomerAccounts();
    InvestmentAccount account = new InvestmentAccount();
    account.setChecksum("checksum-123");
    InvestmentAccountId accountId = new InvestmentAccountId();
    accountId.setAccountNumber("123456");
    account.setInvestmentAccountId(accountId);
    customerAccounts.setInvestmentAccountList(Collections.singletonList(account));

    // Act
    String result = tradeTransferService.findAccountChecksumForAccountNumber(customerAccounts, "123456");

    // Assert
    assertEquals("checksum-123", result);
}

@Test
void findAccountChecksumForAccountNumber_WhenAccountDoesNotExist_ShouldReturnNull() {
    // Arrange
    CustomerAccounts customerAccounts = new CustomerAccounts();
    InvestmentAccount account = new InvestmentAccount();
    account.setChecksum("checksum-123");
    InvestmentAccountId accountId = new InvestmentAccountId();
    accountId.setAccountNumber("123456");
    account.setInvestmentAccountId(accountId);
    customerAccounts.setInvestmentAccountList(Collections.singletonList(account));

    // Act
    String result = tradeTransferService.findAccountChecksumForAccountNumber(customerAccounts, "999999");

    // Assert
    assertNull(result);
}

@Test
void maskNamesInResponse_RetrieveTransferListResponseData_WhenSenderAndReceiverBankCustomer_ShouldMaskNames() {
    // Arrange
    RetrieveTransferListResponseData responseData = new RetrieveTransferListResponseData();
    List<TransferListItemInfo> transferLists = new ArrayList<>();

    // Sender side with isReceiverBankCustomer = "Y"
    TransferListItemInfo senderItem = new TransferListItemInfo();
    senderItem.setTransferSideCode(TransferSideCode.SENDER);
    senderItem.setIsReceiverBankCustomer("Y");
    senderItem.setSenderCustomerFirstName("John");
    senderItem.setSenderCustomerMiddleName("A");
    transferLists.add(senderItem);

    // Receiver side
    TransferListItemInfo receiverItem = new TransferListItemInfo();
    receiverItem.setTransferSideCode(TransferSideCode.RECEIVER);
    receiverItem.setSenderCustomerFirstName("Jane");
    receiverItem.setSenderCustomerMiddleName("B");
    transferLists.add(receiverItem);

    responseData.setTransferLists(transferLists);

    // Act
    tradeTransferService.maskNamesInResponse(responseData);

    // Assert
    assertEquals("J****n", responseData.getTransferLists().get(0).getSenderCustomerFirstName());
    assertEquals("A***", responseData.getTransferLists().get(0).getSenderCustomerMiddleName());
    assertEquals("J****e", responseData.getTransferLists().get(1).getSenderCustomerFirstName());
    assertEquals("B***", responseData.getTransferLists().get(1).getSenderCustomerMiddleName());
}

@Test
void maskNamesInResponse_RetrieveTransferDetailResponseData_WhenSenderAndReceiverBankCustomer_ShouldMaskNames() {
    // Arrange
    RetrieveTransferDetailResponseData responseData = new RetrieveTransferDetailResponseData();
    responseData.setTransferSideCode(TransferSideCode.SENDER);
    responseData.setIsReceiverBankCustomer("Y");
    responseData.setSenderCustomerFirstName("John");
    responseData.setSenderCustomerMiddleName("A");

    // Act
    tradeTransferService.maskNamesInResponse(responseData);

    // Assert
    assertEquals("J****n", responseData.getSenderCustomerFirstName());
    assertEquals("A***", responseData.getSenderCustomerMiddleName());
}

@Test
void maskNamesInResponse_RetrieveTransferDetailResponseData_WhenReceiverAndNotBankCustomer_ShouldNotMaskNames() {
    // Arrange
    RetrieveTransferDetailResponseData responseData = new RetrieveTransferDetailResponseData();
    responseData.setTransferSideCode(TransferSideCode.RECEIVER);
    responseData.setIsReceiverBankCustomer("N");
    responseData.setSenderCustomerFirstName("John");
    responseData.setSenderCustomerMiddleName("A");

    // Act
    tradeTransferService.maskNamesInResponse(responseData);

    // Assert
    assertEquals("John", responseData.getSenderCustomerFirstName());
    assertEquals("A", responseData.getSenderCustomerMiddleName());
}
