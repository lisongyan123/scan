package com.hsbc.trade.transfer.service;

import com.hsbc.trade.HTTPRequestHeaderConstants;
import com.hsbc.trade.common.ResponseDetails;
import com.hsbc.trade.service.RestClientService;
import com.hsbc.trade.service.impl.RetrieveCustomerProfilesServiceImpl;
import com.hsbc.trade.transfer.common.*;
import com.hsbc.trade.transfer.createtransfer.CreateTransferRequest;
import com.hsbc.trade.transfer.createtransfer.CreateTransferRequestData;
import com.hsbc.trade.transfer.createtransfer.CreateTransferResponse;
import com.hsbc.trade.transfer.domain.InvestmentAccountId;
import com.hsbc.trade.transfer.domain.InvestmentAccountIdList;
import com.hsbc.trade.transfer.domain.RetrieveCustomerAccountsIdListResponse;
import com.hsbc.trade.transfer.domain.account.CustomerAccounts;
import com.hsbc.trade.transfer.domain.account.InvestmentAccount;
import com.hsbc.trade.transfer.domain.eligibility.RuleResponse;
import com.hsbc.trade.transfer.domain.mds.GoldPriceResponse;
import com.hsbc.trade.transfer.domain.mds.GoldPriceResponseData;
import com.hsbc.trade.transfer.exception.TransferLimitExceededException;
import com.hsbc.trade.transfer.retrievetransferdetail.RetrieveTransferDetailResponseData;
import com.hsbc.trade.transfer.retrievetransferlimit.RetrieveTransferLimitResponse;
import com.hsbc.trade.transfer.retrievetransferlimit.RetrieveTransferLimitResponseData;
import com.hsbc.trade.transfer.retrievetransferlist.RetrieveTransferListResponse;
import com.hsbc.trade.transfer.retrievetransferlist.RetrieveTransferListResponseData;
import com.hsbc.trade.transfer.service.impl.SreValidationServiceImpl;
import com.hsbc.trade.transfer.service.impl.TradeTransferServiceImpl;
import com.hsbc.trade.transfer.updatetransfer.UpdateTransferRequest;
import com.hsbc.trade.transfer.updatetransfer.UpdateTransferRequestData;
import com.hsbc.trade.transfer.updatetransfer.UpdateTransferResponse;
import com.hsbc.trade.utils.E2ETrustTokenUtil;
import jakarta.ws.rs.InternalServerErrorException;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.test.util.ReflectionTestUtils;

import java.math.BigDecimal;
import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyMap;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class TradeTransferServiceImplTest {

    @InjectMocks
    private TradeTransferServiceImpl tradeTransferService;

    @Mock
    private RestClientService restClientService;

    @Mock
    private RetrieveCustomerProfilesServiceImpl retrieveCustomerProfilesService;

    @Mock
    private SreValidationServiceImpl sreValidationService;

    @Mock
    private E2ETrustTokenUtil e2ETrustTokenUtil;

    private final String dummyToken = "<saml:Assertion xmlns:saml='http://www.hsbc.com/saas/assertion' xmlns:ds='http://www.w3.org/2000/09/xmldsig#' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' ID='id_9a9e4d35-7d80-4805-849f-ddb90a8b2c1f' IssueInstant='2025-08-07T01:25:13.837Z' Version='3.0'><saml:Issuer>https://www.hsbc.com/rbwm/dtp</saml:Issuer><ds:Signature><ds:SignedInfo><ds:CanonicalizationMethod Algorithm='http://www.w3.org/2001/10/xml-exc-c14n#'/><ds:SignatureMethod Algorithm='http://www.w3.org/2001/04/xmldsig-more#rsa-sha256'/><ds:Reference URI='#id_9a9e4d35-7d80-4805-849f-ddb90a8b2c1f'><ds:Transforms><ds:Transform Algorithm='http://www.w3.org/2000/09/xmldsig#enveloped-signature'/><ds:Transform Algorithm='http://www.w3.org/2001/10/xml-exc-c14n#'><ds:InclusiveNamespaces xmlns:ds='http://www.w3.org/2001/10/xml-exc-c14n#' PrefixList='#default saml ds xs xsi'/></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm='http://www.w3.org/2001/04/xmlenc#sha256'/><ds:DigestValue>GLd2xpRi6DRAl81eH6NBRNzVWBlEL1zn5mWNpp16xCk=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>IJQo3CpyjsDRTfXdnQGQnugNniIy56neA0eaLr87DITEauIPFNZHGCk6sb/Wp9PSIxoJNGpF4T5vVPWqUmv1fYasVtrukqodTgK2JD3NHhviDmTVGKzhZ2hnfjSewDRYeqHVURHMWY1EzltUhpZgO9u12i9+PPK4OJLFDR5Q4tZico3GfweUS7+Ds9wYssqgECZg3XayVg5w9ruSdxPIrcjU7aOe2sZFkge+I6cD2OWHC0K+u+PG+DD0UNmK9OnIY///lwgUdhbdSv0zdkUhOcHRKstuFIKhb4E8eZDogB5Sjeqya3EwJ8sIda99n+jug9IrDAjQIBTTnxtMfwq+gQ==</ds:SignatureValue></ds:Signature><saml:Subject><saml:NameID>HK00100718688801</saml:NameID></saml:Subject><saml:Conditions NotBefore='2025-08-07T01:25:12.837Z' NotOnOrAfter='2025-08-07T01:26:13.837Z'/><saml:AttributeStatement><saml:Attribute Name='GUID'><saml:AttributeValue>98b45150-5c73-11ea-8a50-0350565a170c</saml:AttributeValue></saml:Attribute><saml:Attribute Name='CAM'><saml:AttributeValue>30</saml:AttributeValue></saml:Attribute><saml:Attribute Name='KeyAlias'><saml:AttributeValue>E2E_TRUST_SAAS_AP01_BRTB1_ALIAS</saml:AttributeValue></saml:Attribute></saml:AttributeStatement></saml:Assertion>";

    @BeforeEach
    void setUp() {
        ReflectionTestUtils.setField(tradeTransferService, "tradeOnlineUrl", "https://dummy.trade");
        ReflectionTestUtils.setField(tradeTransferService, "customerAccountUrl", "https://dummy.accounts");
        ReflectionTestUtils.setField(tradeTransferService, "retrieveCustomerProfilesService", retrieveCustomerProfilesService);
        ReflectionTestUtils.setField(tradeTransferService, "sreValidationService", sreValidationService);
        when(retrieveCustomerProfilesService.getCIN(any())).thenReturn("dummy-cin");
    }

    @Test
    void retrieveTransferList_ShouldReturnResponse_WhenValidInputProvided() {
        // Arrange
        Map<String, String> requestHeader = new HashMap<>();
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        RetrieveTransferListResponse expectedResponse = new RetrieveTransferListResponse();
        RetrieveTransferListResponseData responseData = new RetrieveTransferListResponseData();
        List<TransferListItemInfo> transferLists = new ArrayList<>();
        TransferListItemInfo item = new TransferListItemInfo();
        item.setTransferReferenceNumber("REF123");
        item.setTransferSideCode(TransferSideCode.SENDER);
        item.setIsReceiverBankCustomer("Y");
        transferLists.add(item);
        responseData.setTransferLists(transferLists);
        expectedResponse.setData(responseData);
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        expectedResponse.setResponseDetails(responseDetails);

        when(restClientService.get(anyString(), any(), eq(RetrieveTransferListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(expectedResponse);

        // Act
        RetrieveTransferListResponse result = tradeTransferService.retrieveTransferList(requestHeader, "ACCEPTED",
                Collections.singletonList("123"), "1", "PROD1", "PLAIN_TEXT");

        // Assert
        assertNotNull(result);
        assertEquals(0, result.getResponseDetails().getResponseCodeNumber());
        assertEquals(1, result.getData().getTransferLists().size());
        assertEquals("REF123", result.getData().getTransferLists().get(0).getTransferReferenceNumber());
    }

    @Test
    void createTransfers_ShouldValidateLimitsAndCallSRE_WhenValidInputProvided() {
        // Arrange
        InvestmentAccountId investmentAccountId = new InvestmentAccountId();
        investmentAccountId.setCountryAccountCode("HK");
        investmentAccountId.setGroupMemberAccountCode("HBAP");
        investmentAccountId.setAccountNumber("123456");
        investmentAccountId.setAccountProductTypeCode("SAV");
        investmentAccountId.setAccountTypeCode("01");
        investmentAccountId.setAccountCurrencyCode("HKD");
        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(investmentAccountId);
        RetrieveCustomerAccountsIdListResponse accountResponse = new RetrieveCustomerAccountsIdListResponse();
        accountResponse.setAccountIdList(Collections.singletonList(accountIdList));
        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(accountResponse);

        CreateTransferRequest request = new CreateTransferRequest();
        CreateTransferRequestData data = new CreateTransferRequestData();
        request.setData(data);
        request.getData().setSenderInvestmentAccountChecksumIdentifier("12345");
        ReceiverInfo receiver = new ReceiverInfo();
        receiver.setTransferQuantity(BigDecimal.valueOf(100));
        receiver.setReceiverCustomerNumber("12345");
        List<ReceiverInfo> receivers = new ArrayList<>();
        receivers.add(receiver);
        request.getData().setReceiverLists(receivers);

        Map<String, String> requestHeader = new HashMap<>();
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        CreateTransferResponse mockCreateTransferResponse = new CreateTransferResponse();
        RuleResponse sreResponse = new RuleResponse();
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        mockCreateTransferResponse.setResponseDetails(responseDetails);
        when(sreValidationService.callSreForTransferValidation(anyString(), anyString(), anyString(), anyMap()))
                .thenReturn(sreResponse);
        when(e2ETrustTokenUtil.updateHeaderForCEP(anyMap())).thenReturn(new HashMap<>());

        // Mock gold price response for D operation
        GoldPriceResponse goldPriceResponse = new GoldPriceResponse();
        GoldPriceResponseData mdsData = new GoldPriceResponseData();
        mdsData.setGoldPriceAmount(BigDecimal.valueOf(1000));
        mdsData.setPublishTime("2025-11-20T10:00:00Z");
        goldPriceResponse.setData(mdsData);
        when(restClientService.get(anyString(), any(), eq(GoldPriceResponse.class), anyInt(), anyBoolean()))
                .thenReturn(goldPriceResponse);

        // Act & Assert
        assertDoesNotThrow(() -> {
            tradeTransferService.createTransfers(requestHeader, request);
        });
        verify(restClientService, times(1)).get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean());
        verify(sreValidationService, times(1)).callSreForTransferValidation(anyString(), anyString(), anyString(), anyMap());
        verify(restClientService, times(1)).post(anyString(), any(), any(), eq(CreateTransferResponse.class), anyInt(), anyBoolean());
    }

    @Test
    void modifyTransfers_ShouldHandleAcceptRejectOperations_WhenValidInputProvided() {
        // Arrange
        InvestmentAccountId investmentAccountId = new InvestmentAccountId();
        investmentAccountId.setCountryAccountCode("HK");
        investmentAccountId.setGroupMemberAccountCode("HBAP");
        investmentAccountId.setAccountNumber("123456");
        investmentAccountId.setAccountProductTypeCode("SAV");
        investmentAccountId.setAccountTypeCode("01");
        investmentAccountId.setAccountCurrencyCode("HKD");
        InvestmentAccountIdList accountIdList = new InvestmentAccountIdList();
        accountIdList.setAccountId(investmentAccountId);
        RetrieveCustomerAccountsIdListResponse accountResponse = new RetrieveCustomerAccountsIdListResponse();
        accountResponse.setAccountIdList(Collections.singletonList(accountIdList));
        when(restClientService.get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean()))
                .thenReturn(accountResponse);

        UpdateTransferRequest request = new UpdateTransferRequest();
        UpdateTransferRequestData data = new UpdateTransferRequestData();
        request.setData(data);
        request.getData().setReceiverInvestmentAccountChecksumIdentifier("12345");
        request.getData().setTransferActionCode(TransferActionCode.A); // Accept

        Map<String, String> requestHeader = new HashMap<>();
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML, dummyToken);
        requestHeader.put(HTTPRequestHeaderConstants.X_HSBC_SAML3, dummyToken);

        UpdateTransferResponse mockUpdateTransferResponse = new UpdateTransferResponse();
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0);
        mockUpdateTransferResponse.setResponseDetails(responseDetails);
        when(sreValidationService.callSreForTransferValidation(anyString(), anyString(), anyString(), anyMap()))
                .thenReturn(new RuleResponse());

        // Act & Assert
        assertDoesNotThrow(() -> {
            tradeTransferService.modifyTransfers(requestHeader, request);
        });
        verify(restClientService, times(1)).get(anyString(), any(), eq(RetrieveCustomerAccountsIdListResponse.class), anyInt(), anyBoolean());
        verify(sreValidationService, times(1)).callSreForTransferValidation(anyString(), anyString(), anyString(), anyMap());
        verify(restClientService, times(1)).put(anyString(), any(), any(), eq(UpdateTransferResponse.class), anyInt(), anyBoolean());
    }

    @Test
    void validateTransferLimits_WhenDailyLimitExceeded_ShouldThrowException() {
        // Arrange
        BigDecimal totalTranAmount = BigDecimal.valueOf(1000);
        RetrieveTransferLimitResponse currentLimit = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponseData data = new RetrieveTransferLimitResponseData();
        data.setAvailableTodayAmount(BigDecimal.valueOf(500)); // Less than total amount
        data.setMaxDailyLimitedAmount(BigDecimal.valueOf(1000));
        currentLimit.setData(data);

        // Act & Assert
        assertThrows(TransferLimitExceededException.class, () -> {
            tradeTransferService.validateTransferLimits(totalTranAmount, currentLimit);
        });
    }

    @Test
    void validateTransferLimits_WhenMonthlyLimitExceeded_ShouldThrowException() {
        // Arrange
        BigDecimal totalTranAmount = BigDecimal.valueOf(1000);
        RetrieveTransferLimitResponse currentLimit = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponseData data = new RetrieveTransferLimitResponseData();
        data.setAvailableMonthToDateAmount(BigDecimal.valueOf(500)); // Less than total amount
        data.setMaxMonthlyLimitedAmount(BigDecimal.valueOf(1000));
        currentLimit.setData(data);

        // Act & Assert
        assertThrows(TransferLimitExceededException.class, () -> {
            tradeTransferService.validateTransferLimits(totalTranAmount, currentLimit);
        });
    }

    @Test
    void validateTransferLimits_WhenYearlyLimitExceeded_ShouldThrowException() {
        // Arrange
        BigDecimal totalTranAmount = BigDecimal.valueOf(1000);
        RetrieveTransferLimitResponse currentLimit = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponseData data = new RetrieveTransferLimitResponseData();
        data.setAvailableYearToDateAmount(BigDecimal.valueOf(500)); // Less than total amount
        data.setMaxYearlyLimitedAmount(BigDecimal.valueOf(1000));
        currentLimit.setData(data);

        // Act & Assert
        assertThrows(TransferLimitExceededException.class, () -> {
            tradeTransferService.validateTransferLimits(totalTranAmount, currentLimit);
        });
    }

    @Test
    void validateTransferLimits_WhenAllLimitsAreSufficient_ShouldNotThrowException() {
        // Arrange
        BigDecimal totalTranAmount = BigDecimal.valueOf(500);
        RetrieveTransferLimitResponse currentLimit = new RetrieveTransferLimitResponse();
        RetrieveTransferLimitResponseData data = new RetrieveTransferLimitResponseData();
        data.setAvailableTodayAmount(BigDecimal.valueOf(1000));
        data.setAvailableMonthToDateAmount(BigDecimal.valueOf(1000));
        data.setAvailableYearToDateAmount(BigDecimal.valueOf(1000));
        currentLimit.setData(data);

        // Act & Assert
        assertDoesNotThrow(() -> {
            tradeTransferService.validateTransferLimits(totalTranAmount, currentLimit);
        });
    }

    @Test
    void handleDOperationResponse_WhenActionIsD_ShouldSetRequestUniqueKeyAndPrice() {
        // Arrange
        CreateTransferRequest createTransferRequest = new CreateTransferRequest();
        CreateTransferRequestData data = new CreateTransferRequestData();
        data.setActionRequestCode(ActionRequestCode.D); // D operation
        createTransferRequest.setData(data);
        CreateTransferResponse createTransferResponse = new CreateTransferResponse();
        CreateTransferRequestData responseData = new CreateTransferRequestData();
        List<TransferOrderInfo> orderInfoList = new ArrayList<>();
        TransferOrderInfo orderInfo = new TransferOrderInfo();
        orderInfo.setRequestPriceValue(BigDecimal.valueOf(100));
        orderInfoList.add(orderInfo);
        createTransferResponse.setData(responseData);
        createTransferResponse.setData(responseData);
        createTransferResponse.setData(responseData);

        GoldPriceResponse goldPriceResponse = new GoldPriceResponse();
        GoldPriceResponseData mdsData = new GoldPriceResponseData();
        mdsData.setGoldPriceAmount(BigDecimal.valueOf(1000));
        mdsData.setPublishTime("2025-11-20T10:00:00Z");
        goldPriceResponse.setData(mdsData);

        // Mock the duplicateSubmitPreventionService to return a unique key
        String mockUniqueKey = "unique-key-123";
        when(tradeTransferService.duplicateSubmitPreventionService.generateUniqueKey()).thenReturn(mockUniqueKey);

        // Act
        tradeTransferService.handleDOperationResponse(createTransferRequest, createTransferResponse, goldPriceResponse);

        // Assert
        assertNotNull(createTransferResponse.getData().getRequestUniqueKey());
        assertEquals(mockUniqueKey, createTransferResponse.getData().getRequestUniqueKey());
        assertEquals(BigDecimal.valueOf(1000), createTransferResponse.getData().getTransferOrderLists().get(0).getRequestPriceValue());
        assertEquals("HKD", createTransferResponse.getData().getTransferOrderLists().get(0).getPriceCurrencyCode());
        assertEquals("2025-11-20T10:00:00Z", createTransferResponse.getData().getTransferOrderLists().get(0).getRequestPriceAsOfDateTime());
    }

    @Test
    void handleDOperationResponse_WhenActionIsNotD_ShouldNotModifyResponse() {
        // Arrange
        CreateTransferRequest createTransferRequest = new CreateTransferRequest();
        CreateTransferRequestData data = new CreateTransferRequestData();
        data.setActionRequestCode(ActionRequestCode.C); // Not D operation
        createTransferRequest.setData(data);
        CreateTransferResponse createTransferResponse = new CreateTransferResponse();
        CreateTransferRequestData responseData = new CreateTransferRequestData();
        List<TransferOrderInfo> orderInfoList = new ArrayList<>();
        TransferOrderInfo orderInfo = new TransferOrderInfo();
        orderInfo.setRequestPriceValue(BigDecimal.valueOf(100));
        orderInfoList.add(orderInfo);
        createTransferResponse.setData(responseData);
        createTransferResponse.setData(responseData);
        createTransferResponse.setData(responseData);

        GoldPriceResponse goldPriceResponse = new GoldPriceResponse();
        GoldPriceResponseData mdsData = new GoldPriceResponseData();
        mdsData.setGoldPriceAmount(BigDecimal.valueOf(1000));
        mdsData.setPublishTime("2025-11-20T10:00:00Z");
        goldPriceResponse.setData(mdsData);

        // Act
        tradeTransferService.handleDOperationResponse(createTransferRequest, createTransferResponse, goldPriceResponse);

        // Assert
        assertNull(createTransferResponse.getData().getRequestUniqueKey()); // Should not be set
        assertEquals(BigDecimal.valueOf(100), createTransferResponse.getData().getTransferOrderLists().get(0).getRequestPriceValue()); // Should remain unchanged
        assertEquals("HKD", createTransferResponse.getData().getTransferOrderLists().get(0).getPriceCurrencyCode()); // Should remain unchanged
        assertEquals("2025-11-20T10:00:00Z", createTransferResponse.getData().getTransferOrderLists().get(0).getRequestPriceAsOfDateTime()); // Should remain unchanged
    }

    @Test
    void findAccountChecksumForAccountNumber_WhenAccountExists_ShouldReturnChecksum() {
        // Arrange
        CustomerAccounts customerAccounts = new CustomerAccounts();
        InvestmentAccount account = new InvestmentAccount();
        account.setChecksum("checksum-123");
        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setAccountNumber("123456");
        account.setInvestmentAccountId(accountId);
        customerAccounts.setInvestmentAccountList(Collections.singletonList(account));

        // Act
        String result = tradeTransferService.findAccountChecksumForAccountNumber(customerAccounts, "123456");

        // Assert
        assertEquals("checksum-123", result);
    }

    @Test
    void findAccountChecksumForAccountNumber_WhenAccountDoesNotExist_ShouldReturnNull() {
        // Arrange
        CustomerAccounts customerAccounts = new CustomerAccounts();
        InvestmentAccount account = new InvestmentAccount();
        account.setChecksum("checksum-123");
        InvestmentAccountId accountId = new InvestmentAccountId();
        accountId.setAccountNumber("123456");
        account.setInvestmentAccountId(accountId);
        customerAccounts.setInvestmentAccountList(Collections.singletonList(account));

        // Act
        String result = tradeTransferService.findAccountChecksumForAccountNumber(customerAccounts, "999999");

        // Assert
        assertNull(result);
    }

    @Test
    void maskNamesInResponse_RetrieveTransferListResponseData_WhenSenderAndReceiverBankCustomer_ShouldMaskNames() {
        // Arrange
        RetrieveTransferListResponseData responseData = new RetrieveTransferListResponseData();
        List<TransferListItemInfo> transferLists = new ArrayList<>();

        // Sender side with isReceiverBankCustomer = "Y"
        TransferListItemInfo senderItem = new TransferListItemInfo();
        senderItem.setTransferSideCode(TransferSideCode.SENDER);
        senderItem.setIsReceiverBankCustomer("Y");
        senderItem.setSenderCustomerFirstName("John");
        senderItem.setSenderCustomerMiddleName("A");
        transferLists.add(senderItem);

        // Receiver side
        TransferListItemInfo receiverItem = new TransferListItemInfo();
        receiverItem.setTransferSideCode(TransferSideCode.RECEIVER);
        receiverItem.setSenderCustomerFirstName("Jane");
        receiverItem.setSenderCustomerMiddleName("B");
        transferLists.add(receiverItem);

        responseData.setTransferLists(transferLists);

        // Act
        tradeTransferService.maskNamesInResponse(responseData);

        // Assert
        assertEquals("J****n", responseData.getTransferLists().get(0).getSenderCustomerFirstName());
        assertEquals("A***", responseData.getTransferLists().get(0).getSenderCustomerMiddleName());
        assertEquals("J****e", responseData.getTransferLists().get(1).getSenderCustomerFirstName());
        assertEquals("B***", responseData.getTransferLists().get(1).getSenderCustomerMiddleName());
    }

    @Test
    void maskNamesInResponse_RetrieveTransferDetailResponseData_WhenSenderAndReceiverBankCustomer_ShouldMaskNames() {
        // Arrange
        RetrieveTransferDetailResponseData responseData = new RetrieveTransferDetailResponseData();
        responseData.setTransferSideCode(TransferSideCode.SENDER);
        responseData.setIsReceiverBankCustomer("Y");
        responseData.setSenderCustomerFirstName("John");
        responseData.setSenderCustomerMiddleName("A");

        // Act
        tradeTransferService.maskNamesInResponse(responseData);

        // Assert
        assertEquals("J****n", responseData.getSenderCustomerFirstName());
        assertEquals("A***", responseData.getSenderCustomerMiddleName());
    }

    @Test
    void maskNamesInResponse_RetrieveTransferDetailResponseData_WhenReceiverAndNotBankCustomer_ShouldNotMaskNames() {
        // Arrange
        RetrieveTransferDetailResponseData responseData = new RetrieveTransferDetailResponseData();
        responseData.setTransferSideCode(TransferSideCode.RECEIVER);
        responseData.setIsReceiverBankCustomer("N");
        responseData.setSenderCustomerFirstName("John");
        responseData.setSenderCustomerMiddleName("A");

        // Act
        tradeTransferService.maskNamesInResponse(responseData);

        // Assert
        assertEquals("John", responseData.getSenderCustomerFirstName());
        assertEquals("A", responseData.getSenderCustomerMiddleName());
    }
}
