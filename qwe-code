import com.hsbc.rtp.client.sre.domain.SreRequest;
import com.hsbc.trade.HTTPRequestHeaderConstants;
import com.hsbc.trade.common.AccountId;
import com.hsbc.trade.service.DuplicateSubmitPreventionService;
import com.hsbc.trade.service.RestClientService;
import com.hsbc.trade.service.impl.RetrieveCustomerProfilesServiceImpl;
import com.hsbc.trade.transfer.common.ActionRequestCode;
import com.hsbc.trade.transfer.constant.TransferQueryParameterConstant;
import com.hsbc.trade.transfer.createtransfer.CreateTransferRequest;
import com.hsbc.trade.transfer.createtransfer.CreateTransferRequestData;
import com.hsbc.trade.transfer.createtransfer.CreateTransferResponse;
import com.hsbc.trade.transfer.createtransfer.ReceiverInfo;
import com.hsbc.trade.transfer.domain.RetrieveCustomerAccountsIdListResponse;
import com.hsbc.trade.transfer.domain.account.CustomerAccounts;
import com.hsbc.trade.transfer.domain.account.InvestmentAccount;
import com.hsbc.trade.transfer.domain.account.InvestmentAccountId;
import com.hsbc.trade.transfer.domain.account.InvestmentAccountIdList;
import com.hsbc.trade.transfer.domain.gold.GoldPriceResponse;
import com.hsbc.trade.transfer.domain.gold.Price;
import com.hsbc.trade.transfer.retrievetransferlimit.RetrieveTransferLimitResponse;
import com.hsbc.trade.transfer.retrievetransferlimit.RetrieveTransferLimitResponseData;
import com.hsbc.trade.transfer.retrievetransferdetail.RetrieveTransferDetailResponse;
import com.hsbc.trade.transfer.retrievetransferdetail.RetrieveTransferDetailResponseData;
import com.hsbc.trade.transfer.retrievetransferlist.RetrieveTransferListResponse;
import com.hsbc.trade.transfer.retrievetransferlist.RetrieveTransferListResponseData;
import com.hsbc.trade.transfer.retrievetransferlist.TransferListItemInfo;
import com.hsbc.trade.transfer.service.TradeTransferService;
import com.hsbc.trade.transfer.service.impl.SreValidationServiceImpl;
import com.hsbc.trade.transfer.service.impl.TradeLimitServiceImpl;
import com.hsbc.trade.utils.E2ETrustTokenUtil;
import com.hsbc.trade.transfer.domain.PartyNameResponse;
import com.hsbc.trade.transfer.domain.PartyContactResponse;
import com.hsbc.trade.transfer.domain.Name;
import com.hsbc.trade.transfer.domain.Contact;
import com.hsbc.trade.transfer.domain.TransferSideCode;
import com.hsbc.trade.transfer.exception.TransferLimitExceededException;
import com.hsbc.trade.transfer.exception.BadRequestException;
import jakarta.ws.rs.InternalServerErrorException;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.test.util.ReflectionTestUtils;
import org.springframework.web.util.UriComponentsBuilder;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class TradeTransferServiceImplTest2 {

    // --- Mocks and InjectMocks (保持不变) ---
    @Mock
    private RestClientService restClientService;

    @Mock
    private E2ETrustTokenUtil e2ETrustTokenUtil;

    @Mock
    private DuplicateSubmitPreventionService duplicateSubmitPreventionService;

    @Mock
    private SreValidationServiceImpl sreValidationService;

    @Mock
    private TradeLimitServiceImpl tradeLimitService;

    @Mock
    private RetrieveCustomerProfilesServiceImpl retrieveCustomerProfilesService;

    @InjectMocks
    private TradeTransferService tradeTransferService;

    private Map<String, String> sourceRequestHeader;

    // --- Constants for mocking URLs (保持不变) ---
    private static final String MOCK_TRADE_ONLINE_URL = "http://mock-trade-online";
    private static final String MOCK_ACCOUNTS_MAP_URL = "http://mock-accounts-map";
    private static final String MOCK_CEP_PARTY_NAME_URL = "http://mock-cep-party-name";
    private static final String MOCK_CEP_PARTY_CONTACT_URL = "http://mock-cep-party-contact";

    @BeforeEach
    void setUp() {
        // --- Set ReflectionTestUtils fields (保持不变) ---
        ReflectionTestUtils.setField(tradeTransferService, "tradeOnlineUrl", MOCK_TRADE_ONLINE_URL);
        ReflectionTestUtils.setField(tradeTransferService, "customerAccountUrl", MOCK_ACCOUNTS_MAP_URL); // For retrieveCustomerAccounts
        ReflectionTestUtils.setField(tradeTransferService, "cepPartyNameUrl", MOCK_CEP_PARTY_NAME_URL);
        ReflectionTestUtils.setField(tradeTransferService, "cepPartyContactUrl", MOCK_CEP_PARTY_CONTACT_URL);
        ReflectionTestUtils.setField(tradeTransferService, "timeout", 10000);
        ReflectionTestUtils.setField(tradeTransferService, "printMessageLog", false);

        sourceRequestHeader = new HashMap<>();
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_COUNTRYCODE, "HK");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CHNL_GROUP_MEMBER, "HBAP");
        sourceRequestHeader.put(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID, "TEST_CIN");
    }

    // ... (其他测试方法如 createTransfers_Success 保持不变) ...

    @Test
    void testRetrieveTransferDetail_Success_WithCustomerName() {
        // Arrange
        String transferReferenceNumber = "ref123";
        String customerInternalNumber = sourceRequestHeader.get(HTTPRequestHeaderConstants.X_HSBC_CUSTOMER_ID); // Extracted from sourceRequestHeader

        // 1. Mock: retrieveTransferDetail Response - CRITICAL: Ensure responseDetails is set!
        RetrieveTransferDetailResponse mockResponse = new RetrieveTransferDetailResponse();
        RetrieveTransferDetailResponseData responseData = new RetrieveTransferDetailResponseData();
        // ✅ 关键修复1：设置一个非空的 AccountId
        AccountId accountId = new AccountId();
        accountId.setAccountNumber("987654321"); // 这个值必须和下面 mock 的 InvestmentAccount 一致
        responseData.setInvestmentAccount(accountId);
        // ✅ 关键修复2：设置 responseDetails！这是 ResponseInfoHandler.prepareResponse 所必需的
        ResponseDetails responseDetails = new ResponseDetails();
        responseDetails.setResponseCodeNumber(0); // ✅ 成功状态码，必须设置！
        responseData.setResponseDetails(responseDetails); // ✅ 将 responseDetails 设置到 data 中 —— 这是关键！
        mockResponse.setData(responseData); // ✅ 设置 data
        mockResponse.setResponseDetails(responseDetails); // ✅ Also set on the main response object if needed by prepareResponse


        // 2. ✅ 关键：Mock CustomerAccounts for retrieveCustomerAccounts() - 这是之前缺失的！
        CustomerAccounts mockCustomerAccounts = new CustomerAccounts();
        List<InvestmentAccount> accList = new ArrayList<>();
        InvestmentAccount acc1 = new InvestmentAccount();
        acc1.setChecksum("chk123");
        // ✅ 创建一个完整的 com.hsbc.trade.transfer.domain.account.AccountId 对象
        com.hsbc.trade.transfer.domain.account.AccountId internalAccountId = new com.hsbc.trade.transfer.domain.account.AccountId();
        internalAccountId.setAccountNumber("987654321"); // This must match the account number in the main AccountId object above
        acc1.setInvestmentAccountId(internalAccountId);
        accList.add(acc1);
        mockCustomerAccounts.setInvestmentAccountList(accList);

        // 3. Mock: PartyNameResponse for retrieveCustomerNamesWithCinNumber
        PartyNameResponse mockPartyNameResponse = new PartyNameResponse();
        Name mockName = new Name();
        mockName.setGivenName("Tom");
        mockName.setLastName("Chan");
        mockName.setCustomerChristianName("King");
        mockPartyNameResponse.setName(mockName);

        // 4. Mock: PartyContactResponse for retrieveCustomerContactWithCinNumber
        PartyContactResponse mockPartyContactResponse = new PartyContactResponse();
        Contact mockContact = new Contact();
        mockContact.setMobileNumber1("123456789");
        mockPartyContactResponse.setContact(mockContact); // getContact() will return this non-null object

        // - CRITICAL: Mock the specific restClientService.get calls with exact URLs and headers -
        // 1. Call for retrieveTransferDetail itself
        when(restClientService.get(
                eq(MOCK_TRADE_ONLINE_URL + "/transfers/{transferReferenceNumber}?customerInternalNumber=" + customerInternalNumber + "&sParameterType=SENS"),
                anyMap(),
                eq(RetrieveTransferDetailResponse.class),
                anyInt(),
                anyBoolean()
        )).thenReturn(mockResponse);

        // 2. Call for retrieveCustomerAccounts (inside retrieveTransferDetail)
        when(restClientService.get(
                eq(MOCK_ACCOUNTS_MAP_URL + "accounts-map?consumerId=DAC"),
                anyMap(),
                eq(CustomerAccounts.class),
                anyInt(),
                anyBoolean()
        )).thenReturn(mockCustomerAccounts);

        // 3. Call for retrieveCustomerNamesWithCinNumber (inside addCustomerNameToUri)
        String sensitiveDataJson = "[{\"key\":\"SensitiveHeadersKey\",\"value\":\"" + customerInternalNumber + "\"}]";
        Map<String, String> expectedHeadersForCEP = new HashMap<>();
        expectedHeadersForCEP.put("X-HSBC-Customer-ID", customerInternalNumber);
        expectedHeadersForCEP.put("X-HSBC-Sensitive-Data", sensitiveDataJson);
        when(e2ETrustTokenUtil.getE2ETrustToken()).thenReturn("mocked-token");
        expectedHeadersForCEP.put("Authorization", "Bearer mocked-token");
        String expectedNameUrl = MOCK_CEP_PARTY_NAME_URL + "customer-number/" + customerInternalNumber;
        when(restClientService.get(
                eq(expectedNameUrl),
                argThat(headers -> headers.equals(expectedHeadersForCEP)),
                eq(PartyNameResponse.class),
                anyInt(),
                anyBoolean()
        )).thenReturn(mockPartyNameResponse);

        // 4. Call for retrieveCustomerContactWithCinNumber (inside addCustomerContactToUri)
        String expectedContactUrl = MOCK_CEP_PARTY_CONTACT_URL + "customer-number/" + customerInternalNumber + "/contact";
        when(restClientService.get(
                eq(expectedContactUrl),
                argThat(headers -> headers.equals(expectedHeadersForCEP)), // Same headers for contact
                eq(PartyContactResponse.class),
                anyInt(),
                anyBoolean()
        )).thenReturn(mockPartyContactResponse);


        // Act
        RetrieveTransferDetailResponse result = tradeTransferService.retrieveTransferDetail(sourceRequestHeader, transferReferenceNumber);

        // Assert
        assertNotNull(result);
        assertNotNull(result.getData());
        assertNotNull(result.getData().getInvestmentAccount());
        assertEquals("987654321", result.getData().getInvestmentAccount().getAccountNumber());
        // ✅ 验证 checksum 被成功设置
        assertNotNull(result.getData().getAccountChecksumIdentifier());
        assertEquals("chk123", result.getData().getAccountChecksumIdentifier());
        // ✅ 验证 responseDetails 被正确设置
        assertNotNull(result.getResponseDetails());
        assertEquals(0, result.getResponseDetails().getResponseCodeNumber());

        // Verify the specific interactions happened
        verify(restClientService, times(1))
                .get(eq(MOCK_TRADE_ONLINE_URL + "/transfers/{transferReferenceNumber}?customerInternalNumber=" + customerInternalNumber + "&sParameterType=SENS"),
                     anyMap(),
                     eq(RetrieveTransferDetailResponse.class),
                     anyInt(),
                     anyBoolean());
        verify(restClientService, times(1))
                .get(eq(MOCK_ACCOUNTS_MAP_URL + "accounts-map?consumerId=DAC"),
                     anyMap(),
                     eq(CustomerAccounts.class),
                     anyInt(),
                     anyBoolean());
        verify(restClientService, times(1))
                .get(eq(expectedNameUrl),
                     argThat(headers -> headers.equals(expectedHeadersForCEP)),
                     eq(PartyNameResponse.class),
                     anyInt(),
                     anyBoolean());
        verify(restClientService, times(1))
                .get(eq(expectedContactUrl),
                     argThat(headers -> headers.equals(expectedHeadersForCEP)),
                     eq(PartyContactResponse.class),
                     anyInt(),
                     anyBoolean());
        verify(e2ETrustTokenUtil, times(2)).getE2ETrustToken(); // Called for name and contact
    }

    // ... (其他测试方法) ...
}
