import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import com.hsbc.trade.transfer.domain.account.*;
import com.hsbc.trade.transfer.domain.cep.PartyContactResponse;
import com.hsbc.trade.transfer.domain.cep.PartyNameResponse;
import com.hsbc.trade.transfer.retrievetransferlist.RetrieveTransferListResponse;
import com.hsbc.trade.transfer.retrievetransferlist.RetrieveTransferListResponseData;
import com.hsbc.trade.transfer.service.TradeTransferService;
import com.hsbc.trade.service.RestClientService; // 确保导入正确
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.web.util.UriComponentsBuilder;

import java.util.*;

@ExtendWith(MockitoExtension.class)
class TradeTransferServiceImplTest {

    @Mock
    private RestClientService restClientService;

    // ... 其他 Mocks 如需要 ...

    @InjectMocks
    private TradeTransferServiceImpl tradeTransferService; // 继承自 AbstractRestService

    private Map<String, String> requestHeaders;
    private String transferStatusCode;
    private List<String> checksumIdentifiers;
    private String pagination;
    private String productId;
    private String sParameterType;

    @BeforeEach
    void setUp() {
        requestHeaders = new HashMap<>();
        requestHeaders.put("X-HSBC-CUSTOMER-ID", "TEST_CIN_12345"); // 示例 CIN
        transferStatusCode = "PENDING";
        checksumIdentifiers = Arrays.asList("CHK1", "CHK2"); // 示例 checksums
        pagination = "{}";
        productId = "GOLD";
        sParameterType = "SENSITIVE";
    }

    @Test
    void retrieveTransferList_Success() {
        System.out.println("Running retrieveTransferList_Success test...");
        // --- Arrange: 设置 Mock 行为 ---

        // 1. Mock retrieveCustomerAccounts() 的返回值
        //    这需要 Mock restClientService.get() 被 retrieveCustomerAccounts() 调用时的行为。
        //    retrieveCustomerAccounts() 内部构建的 URL 格式是: accountsMapUrl + "/accounts-map?consumerId=DAC"
        //    假设 accountsMapUrl 是 "http://accounts-map-service" (这个值通常来自 @Value 注解，在测试中可能需要通过其他方式提供或 Mock UriComponentsBuilder)
        //    为了精确匹配，我们可以使用 anyString() 来匹配 URL，但指定返回的类型是 CustomerAccounts.class
        //    或者，更推荐的方式是使用 ArgumentCaptor 来捕获 URL 并验证它是否符合预期。

        // 创建一个有效的 CustomerAccounts 对象，包含非空的 investmentAccountList
        CustomerAccounts mockCustomerAccounts = new CustomerAccounts();
        List<InvestmentAccount> accountList = new ArrayList<>();

        // 添加至少一个 InvestmentAccount
        InvestmentAccount account1 = new InvestmentAccount();
        AccountId accountId1 = new AccountId();
        accountId1.setAccountNumber("ACC123456789");
        accountId1.setCountryAccountCode("HK");
        accountId1.setGroupMemberAccountCode("HSBC");
        accountId1.setAccountProductTypeCode("GOLD");
        accountId1.setAccountTypeCode("INVEST");
        accountId1.setAccountCurrencyCode("HKD");
        account1.setInvestmentAccountId(accountId1);
        account1.setChecksum("CHK1");
        accountList.add(account1);

        InvestmentAccount account2 = new InvestmentAccount();
        AccountId accountId2 = new AccountId();
        accountId2.setAccountNumber("ACC987654321");
        accountId2.setCountryAccountCode("HK");
        accountId2.setGroupMemberAccountCode("HSBC");
        accountId2.setAccountProductTypeCode("SILVER");
        accountId2.setAccountTypeCode("INVEST");
        accountId2.setAccountCurrencyCode("USD");
        account2.setInvestmentAccountId(accountId2);
        account2.setChecksum("CHK2");
        accountList.add(account2);

        mockCustomerAccounts.setInvestmentAccountList(accountList); // 关键：设置非空列表

        // Mock restClientService.get 调用，返回这个有效的 CustomerAccounts
        // 使用 eq(CustomerAccounts.class) 来精确匹配调用类型
        // 使用 anyString(), anyMap(), anyInt(), anyBoolean() 来匹配其他参数，因为我们主要关心返回值
        // 为了更精确，可以使用 ArgumentCaptor 捕获 URL 并验证它是否包含 "accounts-map"
        when(restClientService.get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean()))
            .thenReturn(mockCustomerAccounts);

        // 2. Mock retrieveCustomerNamesWithCinNumber() 的返回值 (如果需要)
        //    这个方法内部也调用 restClientService.get，可能需要区分
        PartyNameResponse mockPartyNameResponse = new PartyNameResponse(); // 创建实例
        // ... 设置 mockPartyNameResponse 的内容 ...
        when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
            .thenReturn(mockPartyNameResponse);

        // 3. Mock retrieveCustomerPhoneNumberWithCinNumber() 的返回值 (如果需要)
        //    这个方法内部也调用 restClientService.get，可能需要区分
        PartyContactResponse mockPartyContactResponse = new PartyContactResponse(); // 创建实例
        // ... 设置 mockPartyContactResponse 的内容 ...
        when(restClientService.get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean()))
            .thenReturn(mockPartyContactResponse);

        // 4. Mock 主要的 retrieveTransferList API 调用的返回值
        RetrieveTransferListResponse mockMainResponse = new RetrieveTransferListResponse();
        RetrieveTransferListResponseData mockMainResponseData = new RetrieveTransferListResponseData();
        // ... 设置 mockMainResponseData 的内容 ...
        mockMainResponse.setData(mockMainResponseData);
        // Mock the call for RetrieveTransferListResponse.class
        // 这个调用应该发生在 retrieveTransferList 方法的最后
        when(restClientService.get(anyString(), anyMap(), eq(RetrieveTransferListResponse.class), anyInt(), anyBoolean()))
            .thenReturn(mockMainResponse);

        // --- Act: 执行被测方法 ---
        RetrieveTransferListResponse result = tradeTransferService.retrieveTransferList(
            requestHeaders, transferStatusCode, checksumIdentifiers, pagination, productId, sParameterType
        );

        // --- Assert: 验证结果 ---
        assertNotNull(result, "The response from retrieveTransferList should not be null.");
        // 验证 retrieveTransferList 内部调用了 restClientService.get 来获取 CustomerAccounts
        // 验证至少调用了一次获取 CustomerAccounts 的 get 方法
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean());
        // 验证调用了一次获取 PartyName 的 get 方法
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean());
        // 验证调用了一次获取 PartyContact 的 get 方法
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean());
        // 验证调用了一次获取 TransferList 的 get 方法
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(RetrieveTransferListResponse.class), anyInt(), anyBoolean());

        // 如果 retrieveTransferList 方法内部逻辑正确，当 accountIdMap 不为空时，
        // 应该会向 URI 添加 CHECKSUM_IDENTIFIERS 参数。
        // 虽然难以直接在单元测试中验证 URI 的构建，但可以通过验证 `restClientService.get` 被调用的参数来间接推断。
        // 重要的是，`extractAccountIdMap` 不会再返回空，因为 `retrieveCustomerAccounts` 返回了一个包含账户列表的对象。
    }

    @Test
    void retrieveTransferList_EmptyAccountList() {
        System.out.println("Running retrieveTransferList_EmptyAccountList test...");
        // --- Arrange: 设置 Mock 行为，返回空列表 ---
        CustomerAccounts mockCustomerAccountsEmptyList = new CustomerAccounts();
        mockCustomerAccountsEmptyList.setInvestmentAccountList(new ArrayList<>()); // 空列表

        // Mock restClientService.get 返回空列表的 CustomerAccounts
        when(restClientService.get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean()))
            .thenReturn(mockCustomerAccountsEmptyList);

        // Mock other necessary calls (PartyName, PartyContact, Main Response)
        PartyNameResponse mockPartyNameResponse = new PartyNameResponse();
        PartyContactResponse mockPartyContactResponse = new PartyContactResponse();
        RetrieveTransferListResponse mockMainResponse = new RetrieveTransferListResponse();
        RetrieveTransferListResponseData mockMainResponseData = new RetrieveTransferListResponseData();
        mockMainResponse.setData(mockMainResponseData);

        when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
            .thenReturn(mockPartyNameResponse);
        when(restClientService.get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean()))
            .thenReturn(mockPartyContactResponse);
        when(restClientService.get(anyString(), anyMap(), eq(RetrieveTransferListResponse.class), anyInt(), anyBoolean()))
            .thenReturn(mockMainResponse);

        // --- Act: 执行被测方法 ---
        RetrieveTransferListResponse result = tradeTransferService.retrieveTransferList(
            requestHeaders, transferStatusCode, checksumIdentifiers, pagination, productId, sParameterType
        );

        // --- Assert: 验证结果 ---
        assertNotNull(result, "The response should not be null even with an empty account list.");
        // 验证调用次数
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean());
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean());
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean());
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(RetrieveTransferListResponse.class), anyInt(), anyBoolean());
        // 在这种情况下，accountIdMap 会是空的，因此 CHECKSUM_IDENTIFIERS 参数不会被添加到 URI 中。
    }

    @Test
    void retrieveTransferList_NullAccountList() {
        System.out.println("Running retrieveTransferList_NullAccountList test...");
        // --- Arrange: 设置 Mock 行为，返回 null 列表 ---
        CustomerAccounts mockCustomerAccountsNullList = new CustomerAccounts();
        mockCustomerAccountsNullList.setInvestmentAccountList(null); // null 列表

        // Mock restClientService.get 返回 null 列表的 CustomerAccounts
        when(restClientService.get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean()))
            .thenReturn(mockCustomerAccountsNullList);

        // Mock other necessary calls (PartyName, PartyContact, Main Response)
        PartyNameResponse mockPartyNameResponse = new PartyNameResponse();
        PartyContactResponse mockPartyContactResponse = new PartyContactResponse();
        RetrieveTransferListResponse mockMainResponse = new RetrieveTransferListResponse();
        RetrieveTransferListResponseData mockMainResponseData = new RetrieveTransferListResponseData();
        mockMainResponse.setData(mockMainResponseData);

        when(restClientService.get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean()))
            .thenReturn(mockPartyNameResponse);
        when(restClientService.get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean()))
            .thenReturn(mockPartyContactResponse);
        when(restClientService.get(anyString(), anyMap(), eq(RetrieveTransferListResponse.class), anyInt(), anyBoolean()))
            .thenReturn(mockMainResponse);

        // --- Act: 执行被测方法 ---
        RetrieveTransferListResponse result = tradeTransferService.retrieveTransferList(
            requestHeaders, transferStatusCode, checksumIdentifiers, pagination, productId, sParameterType
        );

        // --- Assert: 验证结果 ---
        assertNotNull(result, "The response should not be null even with a null account list.");
        // 验证调用次数
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(CustomerAccounts.class), anyInt(), anyBoolean());
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(PartyNameResponse.class), anyInt(), anyBoolean());
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(PartyContactResponse.class), anyInt(), anyBoolean());
        verify(restClientService, times(1)).get(anyString(), anyMap(), eq(RetrieveTransferListResponse.class), anyInt(), anyBoolean());
        // 在这种情况下，accountIdMap 也会是空的 (Collections.emptyMap())。
    }
}
